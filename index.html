<!doctype html>
<html lang="id" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Indikator Pelayanan Rawat Inap</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body { font-family: Inter, system-ui, sans-serif; }
.metric-card { transition: .3s; }
.metric-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,.15); }
.chart-container { height: 320px; }
.status-good { border-left: 4px solid #10B981 }
.status-warning { border-left: 4px solid #F59E0B }
.status-danger { border-left: 4px solid #EF4444 }
.badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600 }
.badge-green { background:#D1FAE5;color:#065F46 }
.badge-yellow { background:#FEF3C7;color:#92400E }
.badge-red { background:#FEE2E2;color:#991B1B }
.loading-spinner { border:3px solid #eee;border-top:3px solid #4F46E5;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite }
@keyframes spin {100%{transform:rotate(360deg)}}
</style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">

<header class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8">
  <h1 class="text-4xl font-bold">Dashboard Indikator Pelayanan Rawat Inap</h1>
  <p class="opacity-90">RSUD Drs. H. AMRI TAMBUNAN</p>
</header>

<div class="max-w-7xl mx-auto p-6">

<div class="bg-white p-6 rounded-xl shadow mb-6 flex gap-4 items-end">
  <div>
    <label class="font-semibold text-sm">Periode</label>
    <select id="periodeFilter" class="border rounded-lg px-4 py-2">
      <option value="all">Semua Periode</option>
    </select>
  </div>
  <button onclick="location.reload()" class="ml-auto bg-indigo-600 text-white px-6 py-2 rounded-lg">
    <i class="fas fa-sync mr-2"></i>Refresh
  </button>
</div>

<div id="loading" class="flex items-center gap-3 py-10 justify-center">
  <div class="loading-spinner"></div>
  <span>Memuat data...</span>
</div>

<div id="content" style="display:none">

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
  <div class="metric-card bg-white p-6 rounded-xl shadow status-good">
    <span id="borBadge" class="badge badge-green">Normal</span>
    <div class="text-3xl font-bold" id="borValue">0%</div>
    <div class="text-sm text-gray-500">BOR</div>
  </div>

  <div class="metric-card bg-white p-6 rounded-xl shadow status-good">
    <span id="avlosBadge" class="badge badge-green">Normal</span>
    <div class="text-3xl font-bold" id="avlosValue">0</div>
    <div class="text-sm text-gray-500">AVLOS</div>
  </div>

  <div class="metric-card bg-white p-6 rounded-xl shadow status-good">
    <span id="toiBadge" class="badge badge-green">Normal</span>
    <div class="text-3xl font-bold" id="toiValue">0</div>
    <div class="text-sm text-gray-500">TOI</div>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
  <div class="metric-card bg-white p-6 rounded-xl shadow status-good">
    <span id="btoBadge" class="badge badge-green">Normal</span>
    <div class="text-3xl font-bold" id="btoValue">0</div>
    <div class="text-sm text-gray-500">BTO (≥3,3/bln)</div>
  </div>

  <div class="metric-card bg-white p-6 rounded-xl shadow status-good">
    <span id="ndrBadge" class="badge badge-green">Normal</span>
    <div class="text-3xl font-bold" id="ndrValue">0‰</div>
    <div class="text-sm text-gray-500">NDR</div>
  </div>

  <div class="metric-card bg-white p-6 rounded-xl shadow status-good">
    <span id="gdrBadge" class="badge badge-green">Normal</span>
    <div class="text-3xl font-bold" id="gdrValue">0‰</div>
    <div class="text-sm text-gray-500">GDR</div>
  </div>
</div>

<div class="bg-white p-6 rounded-xl shadow mb-6">
  <canvas id="borChart"></canvas>
</div>

<div class="bg-white p-6 rounded-xl shadow overflow-x-auto">
<table class="w-full text-sm">
<thead class="bg-indigo-600 text-white">
<tr>
<th class="p-2">Periode</th>
<th class="p-2">BOR</th>
<th class="p-2">AVLOS</th>
<th class="p-2">TOI</th>
<th class="p-2">BTO</th>
<th class="p-2">NDR</th>
<th class="p-2">GDR</th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>
</div>

</div>
</div>

<script>
const SHEET_ID = "2PACX-1vT28IN0XIYUAf7Q5W7z8ew86twsfpgSEeXocKTVkjnx8zrZvj29LQAyacLy6MrXqRmxaEjdlbLud8bP";
const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?output=csv`;

let rawData=[], chart;

function num(v){
  if(!v) return 0;
  return parseFloat(v.toString().replace(/\./g,'').replace(',','.'))||0;
}

function status(metric,min,max,reverse=false){
  if(reverse){
    if(metric<=max) return ['good','badge-green','Normal'];
    if(metric>max*1.5) return ['danger','badge-red','Bahaya'];
    return ['warning','badge-yellow','Waspada'];
  }
  if(metric>=min && metric<=max) return ['good','badge-green','Normal'];
  if(metric<min||metric>max) return ['warning','badge-yellow','Waspada'];
  return ['danger','badge-red','Bahaya'];
}

fetch(CSV_URL)
.then(r=>r.text())
.then(csv=>{
  Papa.parse(csv,{
    header:true,
    skipEmptyLines:true,
    complete:res=>{
      rawData=res.data.map(r=>({
        periode:r.Periode,
        bor:num(r.BOR),
        avlos:num(r.AVLOS),
        toi:num(r.TOI),
        bto:num(r.BTO),
        ndr:num(r.NDR),
        gdr:num(r.GDR)
      }));
      init();
    }
  })
});

function init(){
  document.getElementById('loading').style.display='none';
  document.getElementById('content').style.display='block';

  const select=document.getElementById('periodeFilter');
  [...new Set(rawData.map(d=>d.periode))].forEach(p=>{
    select.innerHTML+=`<option>${p}</option>`;
  });
  select.onchange=render;
  render();
}

function render(){
  const p=document.getElementById('periodeFilter').value;
  const data=p==='all'?rawData:rawData.filter(d=>d.periode===p);
  const avg=k=>data.reduce((a,b)=>a+b[k],0)/data.length;

  const metrics={
    bor:avg('bor'),
    avlos:avg('avlos'),
    toi:avg('toi'),
    bto:avg('bto'),
    ndr:avg('ndr'),
    gdr:avg('gdr')
  };

  document.getElementById('borValue').innerText=metrics.bor.toFixed(2)+'%';
  document.getElementById('avlosValue').innerText=metrics.avlos.toFixed(2);
  document.getElementById('toiValue').innerText=metrics.toi.toFixed(2);
  document.getElementById('btoValue').innerText=metrics.bto.toFixed(2);
  document.getElementById('ndrValue').innerText=metrics.ndr.toFixed(2)+'‰';
  document.getElementById('gdrValue').innerText=metrics.gdr.toFixed(2)+'‰';

  updateCard('bor',status(metrics.bor,60,85));
  updateCard('avlos',status(metrics.avlos,3,9));
  updateCard('toi',status(metrics.toi,1,3));
  updateCard('bto',metrics.bto>=3.3?['good','badge-green','Normal']:['warning','badge-yellow','Rendah']);
  updateCard('ndr',status(metrics.ndr,0,25,true));
  updateCard('gdr',status(metrics.gdr,0,45,true));

  drawChart(data);
  fillTable(data);
}

function updateCard(id,[s,b,t]){
  const badge=document.getElementById(id+'Badge');
  const card=badge.closest('.metric-card');
  badge.className=`badge ${b}`;
  badge.innerText=t;
  card.classList.remove('status-good','status-warning','status-danger');
  card.classList.add(`status-${s}`);
}

function drawChart(data){
  if(chart) chart.destroy();
  chart=new Chart(borChart,{
    type:'line',
    data:{
      labels:data.map(d=>d.periode),
      datasets:[{label:'BOR',data:data.map(d=>d.bor),borderColor:'#3B82F6',fill:true}]
    }
  });
}

function fillTable(data){
  const tb=document.getElementById('dataTable');
  tb.innerHTML='';
  data.forEach(d=>{
    tb.innerHTML+=`
    <tr>
      <td class="p-2">${d.periode}</td>
      <td class="p-2 text-right">${d.bor.toFixed(2)}</td>
      <td class="p-2 text-right">${d.avlos.toFixed(2)}</td>
      <td class="p-2 text-right">${d.toi.toFixed(2)}</td>
      <td class="p-2 text-right">${d.bto.toFixed(2)}</td>
      <td class="p-2 text-right">${d.ndr.toFixed(2)}</td>
      <td class="p-2 text-right">${d.gdr.toFixed(2)}</td>
    </tr>`;
  });
}
</script>

</body>
</html>
