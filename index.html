<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Indikator Kinerja Rawat Inap</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    /* Dark Mode Variables */
    :root {
      --bg-primary: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 50%, #ffffff 100%);
      --bg-secondary: #ffffff;
      --bg-tertiary: #f3f4f6;
      --bg-blue-50: #eff6ff;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --text-white: #ffffff;
      --border-color: #e5e7eb;
      --card-bg: #ffffff;
      --card-shadow: rgba(0, 0, 0, 0.1);
      --header-gradient: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      --insight-bg: linear-gradient(90deg, #eff6ff 0%, #ffffff 100%);
    }

    [data-theme="dark"] {
      --bg-primary: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --bg-blue-50: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-white: #f1f5f9;
      --border-color: #475569;
      --card-bg: #1e293b;
      --card-shadow: rgba(0, 0, 0, 0.3);
      --header-gradient: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
      --insight-bg: linear-gradient(90deg, #1e293b 0%, #334155 100%);
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: background 0.3s ease, color 0.3s ease;
    }

    .card-bg {
      background-color: var(--card-bg);
      box-shadow: 0 1px 3px var(--card-shadow);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .header-gradient {
      background: var(--header-gradient);
    }

    .insight-box {
      border-left: 4px solid #3b82f6;
      background: var(--insight-bg);
      transition: background 0.3s ease;
    }

    [data-theme="dark"] .insight-box {
      border-left-color: #60a5fa;
    }

    /* Theme Toggle Button */
    .theme-toggle {
      position: relative;
      width: 60px;
      height: 30px;
      background: #cbd5e1;
      border-radius: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    [data-theme="dark"] .theme-toggle {
      background: #475569;
    }

    .theme-toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    [data-theme="dark"] .theme-toggle-slider {
      transform: translateX(30px);
    }
    
    .metric-card {
      transition: all 0.3s ease;
      animation: slideUp 0.6s ease-out;
      background-color: var(--card-bg);
    }
    
    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px var(--card-shadow);
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .chart-container {
      animation: fadeIn 0.8s ease-out;
      background-color: var(--bg-tertiary);
      transition: background-color 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .status-good { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .status-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .status-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }

    .tab-button {
      transition: all 0.3s ease;
      background: var(--card-bg);
      color: var(--text-secondary);
      box-shadow: 0 1px 3px var(--card-shadow);
    }

    .tab-button:hover:not(.active) {
      background: var(--bg-tertiary);
      transform: translateY(-2px);
      box-shadow: 0 4px 6px var(--card-shadow);
    }

    .tab-button.active {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4);
      transform: translateY(-3px);
    }

    .tab-button.active span {
      animation: tabPulse 0.5s ease-out;
    }

    @keyframes tabPulse {
      0% { transform: scale(0.95); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .quick-filter-btn.active {
      background: white !important;
      color: #2563eb !important;
      font-weight: 700;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    /* Bookmark Styles */
    .bookmark-card {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .bookmark-card:hover {
      border-color: #3b82f6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--card-shadow);
    }

    .bookmark-card.active {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    [data-theme="dark"] .bookmark-card.active {
      background: #1e3a8a;
      border-color: #60a5fa;
    }

    /* Floating Action Buttons (Mobile) */
    .fab-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .fab {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
    }

    .fab-menu {
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    .fab-menu.active {
      display: flex;
      animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fab-mini {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--card-bg);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 2px 8px var(--card-shadow);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid var(--border-color);
    }

    .fab-mini:hover {
      transform: scale(1.1);
    }

    /* Print Styles */
    @media print {
      body {
        background: white !important;
      }

      .no-print {
        display: none !important;
      }

      .print-break {
        page-break-after: always;
      }

      .metric-card {
        box-shadow: none !important;
        border: 1px solid #e5e7eb;
        page-break-inside: avoid;
      }

      .chart-container {
        page-break-inside: avoid;
      }

      header {
        background: white !important;
        color: black !important;
        border-bottom: 2px solid #1e40af;
      }

      .tab-button, .quick-filter-btn, .fab-container, #bookmarks-panel {
        display: none !important;
      }

      .tab-content {
        display: block !important;
      }

      h1, h2, h3 {
        color: black !important;
      }

      .text-white {
        color: black !important;
      }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .px-8 { padding-left: 1rem; padding-right: 1rem; }
      .py-6 { padding-top: 1rem; padding-bottom: 1rem; }
      
      .fab-container {
        bottom: 80px;
      }
    }

    @media (max-width: 768px) {
      .px-8 { padding-left: 0.75rem; padding-right: 0.75rem; }
      .py-6 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
      
      .tab-button {
        font-size: 0.875rem;
        padding: 0.75rem 1rem;
      }

      .chart-container {
        padding: 1rem !important;
      }

      .metric-card {
        padding: 1rem !important;
      }

      .fab {
        width: 48px;
        height: 48px;
        font-size: 20px;
      }

      .fab-container {
        bottom: 70px;
        right: 16px;
      }
    }

    @media (max-width: 640px) {
      h1 { font-size: 1.5rem !important; }
      h2 { font-size: 1.25rem !important; }

      .quick-filter-btn {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
      }

      #data-table {
        font-size: 0.75rem;
      }

      #data-table th,
      #data-table td {
        padding: 0.5rem !important;
      }

      .fab-container {
        bottom: 60px;
        right: 12px;
      }
    }

    /* Sidebar Bookmarks Panel */
    #bookmarks-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100%;
      background: var(--card-bg);
      box-shadow: -4px 0 12px var(--card-shadow);
      z-index: 2000;
      transition: right 0.3s ease;
      overflow-y: auto;
    }

    #bookmarks-panel.active {
      right: 0;
    }

    @media (max-width: 640px) {
      #bookmarks-panel {
        width: 100%;
        right: -100%;
      }
    }

    /* Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      display: none;
    }

    .overlay.active {
      display: block;
    }

    /* Tablet Optimizations */
    @media (min-width: 768px) and (max-width: 1024px) {
      .grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3.xl\\:grid-cols-6 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .chart-container {
        padding: 1.5rem !important;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full w-full overflow-auto">
  <div class="min-h-full w-full"><!-- Overlay for Bookmarks Panel -->
   <div class="overlay" id="overlay"></div><!-- Bookmarks Panel -->
   <div id="bookmarks-panel" class="p-6">
    <div class="flex items-center justify-between mb-6">
     <h2 class="text-2xl font-bold" style="color: var(--text-primary);">ğŸ“š Bookmarks Saya</h2><button id="close-bookmarks" class="text-3xl" style="color: var(--text-secondary);">Ã—</button>
    </div>
    <div class="mb-6">
     <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">ğŸ’¾ Simpan Filter Saat Ini</h3><input type="text" id="bookmark-name" placeholder="Nama bookmark..." class="w-full px-4 py-2 rounded-lg border mb-3" style="background: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary);"> <button id="save-bookmark" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all"> âœ“ Simpan Bookmark </button>
    </div>
    <div class="mb-4">
     <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">â­ Bookmark Tersimpan</h3>
     <div id="bookmarks-list" class="space-y-3">
      <p class="text-sm" style="color: var(--text-secondary);">Belum ada bookmark tersimpan</p>
     </div>
    </div>
   </div><!-- Floating Action Buttons (Mobile) -->
   <div class="fab-container no-print">
    <div class="fab-menu" id="fab-menu">
     <div class="fab-mini" id="fab-bookmark" title="Bookmarks">
      ğŸ“š
     </div>
     <div class="fab-mini" id="fab-theme" title="Toggle Theme">
      ğŸŒ“
     </div>
     <div class="fab-mini" id="fab-print" title="Print">
      ğŸ–¨ï¸
     </div>
    </div>
    <div class="fab" id="fab-main">
     âš™ï¸
    </div>
   </div><!-- Loading Indicator -->
   <div id="loading-indicator" class="fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white bg-opacity-95 z-50">
    <div class="text-center">
     <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mb-4"></div>
     <p class="text-xl font-semibold text-gray-800">ğŸ“Š Memuat data dari Google Sheets...</p>
     <p class="text-sm text-gray-600 mt-2">Mohon tunggu sebentar</p>
    </div>
   </div><!-- Error Indicator -->
   <div id="error-indicator" class="fixed top-4 left-1/2 transform -translate-x-1/2 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-lg z-50 max-w-3xl card-bg" style="display: none;">
    <div class="flex items-start gap-3"><span class="text-2xl">âš ï¸</span>
     <div class="flex-1">
      <p class="font-semibold text-lg mb-2">Gagal memuat data dari Google Sheets</p>
      <div id="error-details" class="text-sm mt-2 space-y-1">
       <p><strong>Status:</strong> <span id="error-status">-</span></p>
       <p><strong>Detail:</strong> <span id="error-message">-</span></p>
      </div>
      <div class="mt-3 flex gap-2 flex-wrap"><button id="retry-load-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-all text-sm"> ğŸ”„ Coba Lagi </button> <button id="test-url-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all text-sm"> ğŸ”— Test URL di Tab Baru </button>
      </div>
     </div>
    </div>
   </div><!-- Header -->
   <header class="px-8 py-6 header-gradient no-print" style="box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
     <div>
      <h1 id="dashboard-title" class="text-3xl font-bold mb-1" style="color: var(--text-white);">Dashboard Indikator Kinerja Rawat Inap</h1>
      <p id="hospital-name" class="text-lg text-blue-100">RSUD Drs. H. AMRI TAMBUNAN</p>
     </div>
     <div class="flex flex-col items-end gap-3">
      <div class="flex items-center gap-3"><!-- Theme Toggle -->
       <div class="flex items-center gap-2"><span class="text-sm font-semibold text-blue-100">â˜€ï¸</span>
        <div class="theme-toggle" id="theme-toggle">
         <div class="theme-toggle-slider">
          ğŸŒ™
         </div>
        </div><span class="text-sm font-semibold text-blue-100">ğŸŒ™</span>
       </div>
      </div>
      <div class="text-right">
       <p id="period-label" class="text-sm text-blue-100 mb-1">Periode Laporan:</p>
       <p id="current-period" class="text-xl font-semibold" style="color: var(--text-white);">Memuat data...</p>
      </div>
      <div class="flex gap-2"><button id="bookmarks-btn" class="px-4 py-2 bg-white bg-opacity-20 backdrop-blur-sm text-white rounded-lg font-semibold hover:bg-opacity-30 transition-all flex items-center gap-2"> ğŸ“š Bookmarks </button> <button id="export-pdf-btn" class="px-4 py-2 bg-white text-blue-600 rounded-lg font-semibold hover:bg-blue-50 transition-all flex items-center gap-2"> ğŸ–¨ï¸ Print </button>
      </div>
     </div>
    </div><!-- Filter Dashboard Utama -->
    <div id="dashboard-filters" class="bg-white bg-opacity-10 rounded-lg p-4 backdrop-blur-sm">
     <div class="flex flex-wrap gap-3 mb-3"><button id="filter-bulan-ini" class="quick-filter-btn active px-6 py-2 bg-white text-blue-600 rounded-lg font-semibold hover:bg-blue-50 transition-all duration-200 shadow-md"> ğŸ“… Bulan Ini </button> <button id="filter-bulan-lalu" class="quick-filter-btn px-6 py-2 bg-white bg-opacity-50 text-white rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition-all duration-200"> ğŸ“† Bulan Lalu </button> <button id="filter-tahun-ini" class="quick-filter-btn px-6 py-2 bg-white bg-opacity-50 text-white rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition-all duration-200"> ğŸ“Š Tahun Ini </button> <button id="filter-tahun-lalu" class="quick-filter-btn px-6 py-2 bg-white bg-opacity-50 text-white rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition-all duration-200"> ğŸ“… Tahun Lalu </button> <button id="filter-custom" class="quick-filter-btn px-6 py-2 bg-white bg-opacity-50 text-white rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition-all duration-200"> ğŸ” Pilih Periode </button>
     </div><!-- Custom Period Selector -->
     <div id="custom-period-selector" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4" style="display: none;">
      <div><label for="custom-year" class="block text-sm font-medium text-white mb-2">ğŸ“… Tahun</label> <select id="custom-year" class="w-full px-4 py-2 rounded-lg border-0 focus:ring-2 focus:ring-blue-300 font-medium" style="background: var(--bg-secondary); color: var(--text-primary);"> <option value="all">Semua Tahun</option> </select>
      </div>
      <div><label for="custom-month" class="block text-sm font-medium text-white mb-2">ğŸ“† Bulan</label> <select id="custom-month" class="w-full px-4 py-2 rounded-lg border-0 focus:ring-2 focus:ring-blue-300 font-medium" style="background: var(--bg-secondary); color: var(--text-primary);"> <option value="all">Semua Bulan</option> <option value="Jan">Januari</option> <option value="Feb">Februari</option> <option value="Mar">Maret</option> <option value="Apr">April</option> <option value="Mei">Mei</option> <option value="Jun">Juni</option> <option value="Jul">Juli</option> <option value="Agu">Agustus</option> <option value="Sep">September</option> <option value="Okt">Oktober</option> <option value="Nov">November</option> <option value="Des">Desember</option> </select>
      </div>
      <div class="flex items-end"><button id="apply-custom-filter" class="w-full px-6 py-2 bg-white text-blue-600 rounded-lg font-semibold hover:bg-blue-50 transition-all duration-200 shadow-md"> âœ“ Terapkan </button>
      </div>
     </div>
    </div><!-- Filter Tab Lain -->
    <div id="other-tabs-filters" class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-white bg-opacity-10 rounded-lg p-4 backdrop-blur-sm" style="display: none;">
     <div><label for="year-filter" class="block text-sm font-medium text-white mb-2">ğŸ“… Tahun</label> <select id="year-filter" class="w-full px-4 py-2 rounded-lg border-0 focus:ring-2 focus:ring-blue-300 font-medium" style="background: var(--bg-secondary); color: var(--text-primary);"> <option value="all">Semua Tahun</option> </select>
     </div>
     <div><label for="month-filter" class="block text-sm font-medium text-white mb-2">ğŸ“† Bulan</label> <select id="month-filter" class="w-full px-4 py-2 rounded-lg border-0 focus:ring-2 focus:ring-blue-300 font-medium" style="background: var(--bg-secondary); color: var(--text-primary);"> <option value="all" selected>Semua Bulan</option> <option value="Jan">Januari</option> <option value="Feb">Februari</option> <option value="Mar">Maret</option> <option value="Apr">April</option> <option value="Mei">Mei</option> <option value="Jun">Juni</option> <option value="Jul">Juli</option> <option value="Agu">Agustus</option> <option value="Sep">September</option> <option value="Okt">Oktober</option> <option value="Nov">November</option> <option value="Des">Desember</option> </select>
     </div>
     <div class="flex items-end"><button id="reset-filter" class="w-full px-6 py-2 bg-white text-blue-600 rounded-lg font-semibold hover:bg-blue-50 transition-all duration-200 shadow-md"> ğŸ”„ Reset Filter </button>
     </div>
    </div>
   </header><!-- Print Header (Only Visible When Printing) -->
   <div class="hidden print:block px-8 py-4 border-b-2 border-blue-600">
    <h1 class="text-2xl font-bold text-gray-900">Dashboard Indikator Kinerja Rawat Inap</h1>
    <p class="text-lg text-gray-700">RSUD Drs. H. AMRI TAMBUNAN</p>
    <p class="text-sm text-gray-600 mt-2">Dicetak pada: <span id="print-date"></span></p>
    <p class="text-sm text-gray-600">Periode: <span id="print-period"></span></p>
   </div><!-- Tab Navigation -->
   <section class="px-8 py-6 no-print">
    <div class="card-bg rounded-xl shadow-lg overflow-hidden">
     <div class="flex gap-2 p-2" style="background: var(--bg-tertiary);"><button id="tab-dashboard" class="tab-button flex-1 px-6 py-4 font-bold rounded-lg focus:outline-none transition-all duration-300 active"> <span class="flex items-center justify-center gap-2"> <span class="text-2xl">ğŸ </span> <span class="hidden sm:inline">Dashboard Utama</span> <span class="sm:hidden">Dashboard</span> </span> </button> <button id="tab-pelayanan" class="tab-button flex-1 px-6 py-4 font-bold rounded-lg focus:outline-none transition-all duration-300"> <span class="flex items-center justify-center gap-2"> <span class="text-2xl">ğŸ“Š</span> <span class="hidden sm:inline">Analisis Pelayanan</span> <span class="sm:hidden">Pelayanan</span> </span> </button> <button id="tab-mutu" class="tab-button flex-1 px-6 py-4 font-bold rounded-lg focus:outline-none transition-all duration-300"> <span class="flex items-center justify-center gap-2"> <span class="text-2xl">âš•ï¸</span> <span class="hidden sm:inline">Mutu &amp; Keselamatan</span> <span class="sm:hidden">Mutu</span> </span> </button>
     </div>
    </div>
   </section><!-- TAB 1: Dashboard Utama -->
   <div id="content-dashboard" class="tab-content active"><!-- Metric Cards -->
    <section class="px-8 py-6">
     <div class="mb-4 p-4 rounded-lg shadow-sm" style="background: var(--bg-blue-50); border-left: 4px solid #3b82f6;">
      <p class="text-sm font-semibold" style="color: var(--text-primary);">ğŸ“Š Data Card: <span id="card-period-info" class="font-bold text-blue-700">Memuat...</span></p>
      <p class="text-xs mt-1" style="color: var(--text-secondary);">Card menampilkan data sesuai filter yang dipilih</p>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 print-break"><!-- BOR Card -->
      <div class="metric-card rounded-xl shadow-md p-5" style="animation-delay: 0.1s;">
       <div class="flex items-center justify-between mb-3">
        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-2xl" id="bor-icon-bg">
         ğŸ¥
        </div>
        <div id="bor-status" class="w-3 h-3 rounded-full"></div>
       </div>
       <h3 class="text-sm font-semibold mb-1" style="color: var(--text-secondary);">BOR</h3>
       <p id="bor-value" class="text-3xl font-bold mb-1" style="color: var(--text-primary);">--</p>
       <p class="text-xs" style="color: var(--text-secondary);">Target: 60-85%</p>
      </div><!-- AVLOS Card -->
      <div class="metric-card rounded-xl shadow-md p-5" style="animation-delay: 0.15s;">
       <div class="flex items-center justify-between mb-3">
        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-2xl" id="avlos-icon-bg">
         â±ï¸
        </div>
        <div id="avlos-status" class="w-3 h-3 rounded-full"></div>
       </div>
       <h3 class="text-sm font-semibold mb-1" style="color: var(--text-secondary);">AVLOS</h3>
       <p id="avlos-value" class="text-3xl font-bold mb-1" style="color: var(--text-primary);">--</p>
       <p class="text-xs" style="color: var(--text-secondary);">Target: 6-9 hari</p>
      </div><!-- TOI Card -->
      <div class="metric-card rounded-xl shadow-md p-5" style="animation-delay: 0.2s;">
       <div class="flex items-center justify-between mb-3">
        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-2xl" id="toi-icon-bg">
         ğŸ›ï¸
        </div>
        <div id="toi-status" class="w-3 h-3 rounded-full"></div>
       </div>
       <h3 class="text-sm font-semibold mb-1" style="color: var(--text-secondary);">TOI</h3>
       <p id="toi-value" class="text-3xl font-bold mb-1" style="color: var(--text-primary);">--</p>
       <p class="text-xs" style="color: var(--text-secondary);">Target: 1-3 hari</p>
      </div><!-- BTO Card -->
      <div class="metric-card rounded-xl shadow-md p-5" style="animation-delay: 0.25s;">
       <div class="flex items-center justify-between mb-3">
        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-2xl" id="bto-icon-bg">
         ğŸ”
        </div>
        <div id="bto-status" class="w-3 h-3 rounded-full"></div>
       </div>
       <h3 class="text-sm font-semibold mb-1" style="color: var(--text-secondary);">BTO</h3>
       <p id="bto-value" class="text-3xl font-bold mb-1" style="color: var(--text-primary);">--</p>
       <p class="text-xs" style="color: var(--text-secondary);">Target: 40-50 kali</p>
      </div><!-- NDR Card -->
      <div class="metric-card rounded-xl shadow-md p-5" style="animation-delay: 0.3s;">
       <div class="flex items-center justify-between mb-3">
        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-2xl" id="ndr-icon-bg">
         ğŸ’”
        </div>
        <div id="ndr-status" class="w-3 h-3 rounded-full"></div>
       </div>
       <h3 class="text-sm font-semibold mb-1" style="color: var(--text-secondary);">NDR</h3>
       <p id="ndr-value" class="text-3xl font-bold mb-1" style="color: var(--text-primary);">--</p>
       <p class="text-xs" style="color: var(--text-secondary);">Target: â‰¤ 25â€°</p>
      </div><!-- GDR Card -->
      <div class="metric-card rounded-xl shadow-md p-5" style="animation-delay: 0.35s;">
       <div class="flex items-center justify-between mb-3">
        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-2xl" id="gdr-icon-bg">
         ğŸ“ˆ
        </div>
        <div id="gdr-status" class="w-3 h-3 rounded-full"></div>
       </div>
       <h3 class="text-sm font-semibold mb-1" style="color: var(--text-secondary);">GDR</h3>
       <p id="gdr-value" class="text-3xl font-bold mb-1" style="color: var(--text-primary);">--</p>
       <p class="text-xs" style="color: var(--text-secondary);">Target: &lt; 45â€°</p>
      </div>
     </div>
    </section><!-- Charts Section -->
    <section class="px-8 py-6 print-break">
     <div class="card-bg rounded-xl shadow-md p-6">
      <h2 class="text-2xl font-bold mb-4" style="color: var(--text-primary);">ğŸ“ˆ Tren Indikator Kinerja</h2><!-- Chart Controls -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 rounded-lg no-print" style="background: var(--bg-blue-50);">
       <div><label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">ğŸ“… Pilih Tahun</label>
        <div id="chart-year-checkboxes" class="flex flex-wrap gap-2"><!-- Checkboxes will be populated dynamically -->
        </div>
       </div>
       <div><label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">ğŸ“Š Tipe Chart</label> <select id="chart-type-selector" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 text-sm font-medium" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);"> <option value="line">ğŸ“ˆ Line Chart</option> <option value="bar">ğŸ“Š Bar Chart</option> </select>
       </div>
       <div><label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">ğŸ“‰ Periode Tampilan</label> <select id="chart-period-type" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 text-sm font-medium" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);"> <option value="monthly">Data Bulanan</option> <option value="yearly">Data Tahunan</option> </select>
       </div>
      </div>
      <div class="flex items-center justify-between mb-6 p-4 rounded-lg no-print" style="background: var(--bg-blue-50);"><label class="flex items-center gap-2 text-sm font-semibold cursor-pointer" style="color: var(--text-primary);"> <input type="checkbox" id="chart-show-values" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer"> <span>ğŸ”¢ Tampilkan Nilai di Setiap Titik Grafik</span> </label>
       <div class="flex items-center gap-2"><label class="text-sm font-semibold" style="color: var(--text-primary);">ğŸ“¥ Export Grafik:</label> <button id="export-charts-png" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700 transition-all">PNG</button> <button id="export-charts-svg" class="px-4 py-2 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition-all">SVG</button>
       </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
       <div class="chart-container rounded-lg p-4">
        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">BOR &amp; AVLOS</h3>
        <canvas id="chart-bor-avlos"></canvas>
       </div>
       <div class="chart-container rounded-lg p-4">
        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">TOI &amp; BTO</h3>
        <canvas id="chart-toi-bto"></canvas>
       </div>
       <div class="chart-container rounded-lg p-4">
        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">NDR &amp; GDR</h3>
        <canvas id="chart-ndr-gdr"></canvas>
       </div>
       <div class="chart-container rounded-lg p-4">
        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">Pasien Masuk &amp; Keluar</h3>
        <canvas id="chart-pasien"></canvas>
       </div>
      </div>
     </div>
    </section><!-- Insights Section -->
    <section class="px-8 py-6">
     <div class="card-bg rounded-xl shadow-md p-6">
      <h2 class="text-2xl font-bold mb-4" style="color: var(--text-primary);">ğŸ’¡ Insight &amp; Analisis</h2>
      <div id="insights-container" class="space-y-4">
       <div class="insight-box p-4 rounded-lg">
        <p class="text-sm" style="color: var(--text-primary);">Memuat insight...</p>
       </div>
      </div>
     </div>
    </section>
   </div><!-- TAB 2: Analisis Pelayanan -->
   <div id="content-pelayanan" class="tab-content"><!-- Chart Controls for Pelayanan -->
    <section class="px-8 py-6">
     <div class="card-bg rounded-xl shadow-md p-6">
      <h2 class="text-2xl font-bold mb-4" style="color: var(--text-primary);">ğŸ“Š Analisis Tren Pelayanan Rawat Inap</h2><!-- Chart Controls -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 rounded-lg no-print" style="background: var(--bg-blue-50);">
       <div><label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">ğŸ“… Pilih Tahun</label>
        <div id="pelayanan-year-checkboxes" class="flex flex-wrap gap-2"><!-- Checkboxes will be populated dynamically -->
        </div>
       </div>
       <div><label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">ğŸ“Š Tipe Chart</label> <select id="pelayanan-chart-type" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 text-sm font-medium" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);"> <option value="line">ğŸ“ˆ Line Chart</option> <option value="bar">ğŸ“Š Bar Chart</option> </select>
       </div>
       <div><label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">ğŸ“‰ Periode Tampilan</label> <select id="pelayanan-period-type" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 text-sm font-medium" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);"> <option value="monthly">Data Bulanan</option> <option value="yearly">Data Tahunan</option> </select>
       </div>
      </div>
      <div class="flex items-center justify-between mb-6 p-4 rounded-lg flex-wrap gap-3 no-print" style="background: var(--bg-blue-50);"><label class="flex items-center gap-2 text-sm font-semibold cursor-pointer" style="color: var(--text-primary);"> <input type="checkbox" id="pelayanan-show-values" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer"> <span>ğŸ”¢ Tampilkan Nilai di Setiap Titik Grafik</span> </label>
       <div class="flex items-center gap-2"><label class="text-sm font-semibold" style="color: var(--text-primary);">ğŸ“¥ Export Grafik:</label> <button id="export-pelayanan-png" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700 transition-all">PNG</button> <button id="export-pelayanan-svg" class="px-4 py-2 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition-all">SVG</button>
       </div>
      </div><!-- Charts Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
       <div class="chart-container rounded-lg p-4">
        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">ğŸ‘¥ Tren Pasien Rawat Inap</h3>
        <canvas id="chart-pelayanan-pasien"></canvas>
       </div>
       <div class="chart-container rounded-lg p-4">
        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">ğŸ¥ BOR dan Kapasitas Tempat Tidur</h3>
        <canvas id="chart-pelayanan-bor-kapasitas"></canvas>
       </div>
       <div class="chart-container rounded-lg p-4 lg:col-span-2">
        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">ğŸ“… Tren Hari Rawatan dan Lama Dirawat</h3>
        <canvas id="chart-pelayanan-rawatan"></canvas>
       </div>
      </div>
     </div>
    </section><!-- Data Table Section -->
    <section class="px-8 py-6">
     <div class="card-bg rounded-xl shadow-md p-6">
      <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
       <div>
        <h2 class="text-2xl font-bold" style="color: var(--text-primary);">ğŸ“Š Tabel Data Lengkap</h2>
        <div class="flex items-center gap-3 mt-2"><span id="table-counter" class="text-sm font-semibold" style="color: var(--text-secondary);"> Menampilkan <span id="displayed-rows">0</span> dari <span id="total-rows">0</span> data </span> <span id="filter-badge" class="hidden px-3 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded-full"> ğŸ” Filter Aktif </span>
        </div>
       </div>
       <div class="flex items-center gap-2 no-print"><label class="text-sm font-semibold" style="color: var(--text-primary);">ğŸ“¥ Export:</label> <button id="export-table-csv" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700 transition-all">CSV</button> <button id="export-table-excel" class="px-4 py-2 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition-all">Excel</button>
       </div>
      </div><!-- Search and Column Selector -->
      <div class="flex items-center gap-4 mb-4 flex-wrap no-print"><!-- Search Box -->
       <div class="flex-1 min-w-[300px]">
        <div class="relative"><span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-lg" style="color: var(--text-secondary);">ğŸ”</span> <input type="text" id="table-search" placeholder="Cari periode, BOR, AVLOS, jumlah pasien..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
        </div>
       </div><!-- Rows Per Page Selector -->
       <div class="flex items-center gap-2"><label class="text-sm font-semibold whitespace-nowrap" style="color: var(--text-primary);">ğŸ“‹ Tampilkan:</label> <select id="rows-per-page" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm font-medium" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);"> <option value="10">10 baris</option> <option value="25">25 baris</option> <option value="50">50 baris</option> <option value="100">100 baris</option> <option value="all">Semua</option> </select>
       </div><!-- Column Selector Button -->
       <div class="relative"><button id="column-selector-btn" class="px-4 py-2 rounded-lg font-semibold hover:bg-opacity-80 transition-all flex items-center gap-2 border" style="background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-color);"> âš™ï¸ Pilih Kolom <span id="column-count-badge" class="px-2 py-0.5 bg-blue-600 text-white text-xs rounded-full">18</span> </button> <!-- Dropdown Menu -->
        <div id="column-selector-dropdown" class="hidden absolute right-0 mt-2 w-96 rounded-lg shadow-2xl border z-50 max-h-[500px] overflow-y-auto" style="background: var(--card-bg); border-color: var(--border-color);">
         <div class="p-4 border-b" style="background: var(--bg-blue-50); border-color: var(--border-color);">
          <h3 class="font-bold mb-3" style="color: var(--text-primary);">ğŸ“‹ Pilih Kolom yang Ditampilkan</h3>
          <div class="flex gap-2"><button id="select-all-columns" class="flex-1 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700 transition-all"> âœ“ Pilih Semua </button> <button id="deselect-all-columns" class="flex-1 px-3 py-1.5 bg-gray-600 text-white rounded-lg text-xs font-semibold hover:bg-gray-700 transition-all"> âœ— Hapus Semua </button>
          </div>
         </div>
         <div class="p-4 grid grid-cols-2 gap-3" id="column-checkboxes-container"><!-- Column checkboxes will be populated here -->
         </div>
        </div>
       </div>
      </div><!-- Table Container -->
      <div class="overflow-x-auto rounded-lg border" style="max-height: 600px; overflow-y: auto; border-color: var(--border-color);">
       <table id="data-table" class="w-full text-sm">
        <thead class="bg-gradient-to-r from-blue-600 to-blue-500 text-white sticky top-0 z-10">
         <tr>
          <th class="px-3 py-3 text-center sticky left-0 bg-blue-600 z-20" data-column="no">No</th>
          <th class="px-4 py-3 text-left sticky left-[60px] bg-blue-600 z-20" data-column="periode">Periode</th>
          <th class="px-4 py-3 text-right" data-column="pasien-masuk">Pasien Masuk</th>
          <th class="px-4 py-3 text-right" data-column="pasien-keluar">Pasien Keluar</th>
          <th class="px-4 py-3 text-right" data-column="pasien-dirawat">Pasien Dirawat</th>
          <th class="px-4 py-3 text-right" data-column="jumlah-tt">Jumlah TT</th>
          <th class="px-4 py-3 text-right" data-column="jumlah-hari">Jumlah Hari</th>
          <th class="px-4 py-3 text-right" data-column="hari-rawatan">Hari Rawatan</th>
          <th class="px-4 py-3 text-right" data-column="lama-dirawat">Lama Dirawat</th>
          <th class="px-4 py-3 text-right" data-column="meninggal-48">Meninggal â‰¥48 Jam</th>
          <th class="px-4 py-3 text-right" data-column="meninggal-kurang-48">Meninggal &lt;48 Jam</th>
          <th class="px-4 py-3 text-right" data-column="total-meninggal">Total Meninggal</th>
          <th class="px-4 py-3 text-right" data-column="bor">BOR (%)</th>
          <th class="px-4 py-3 text-right" data-column="avlos">AVLOS</th>
          <th class="px-4 py-3 text-right" data-column="toi">TOI</th>
          <th class="px-4 py-3 text-right" data-column="bto">BTO</th>
          <th class="px-4 py-3 text-right" data-column="ndr">NDR (â€°)</th>
          <th class="px-4 py-3 text-right" data-column="gdr">GDR (â€°)</th>
         </tr>
        </thead>
        <tbody id="data-table-body">
        </tbody>
       </table>
      </div>
     </div>
    </section>
   </div><!-- TAB 3: Mutu & Keselamatan -->
   <div id="content-mutu" class="tab-content">
    <section class="px-8 py-6">
     <div class="card-bg rounded-xl shadow-md p-6">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-2xl font-bold" style="color: var(--text-primary);">âš•ï¸ Analisis Mutu &amp; Keselamatan Pasien</h2>
       <div class="flex items-center gap-2 no-print"><label class="text-sm font-semibold" style="color: var(--text-primary);">ğŸ“¥ Export Grafik:</label> <button id="export-mortality-png" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700 transition-all">PNG</button> <button id="export-mortality-svg" class="px-4 py-2 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition-all">SVG</button>
       </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
       <div class="chart-container rounded-lg p-4">
        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">Tren Angka Kematian</h3>
        <canvas id="chart-mortality"></canvas>
       </div>
       <div class="chart-container rounded-lg p-4">
        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">Kematian â‰¥48 Jam vs &lt;48 Jam</h3>
        <canvas id="chart-mortality-breakdown"></canvas>
       </div>
      </div>
      <div id="mortality-insights" class="mt-6 space-y-4">
      </div>
     </div>
    </section>
   </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Register the datalabels plugin
    Chart.register(ChartDataLabels);

    const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT28IN0XIYUAf7Q5W7z8ew86twsfpgSEeXocKTVkjnx8zrZvj29LQAyacLy6MrXqRmxaEjdlbLud8bP/pub?gid=0&single=true&output=csv';

    let rawData = [];
    let currentFilter = 'bulan-ini';
    let charts = {};
    let pelayananCharts = {};
    let chartSettings = {
      selectedYears: [],
      type: 'line',
      showValues: false,
      periodType: 'monthly'
    };
    let pelayananSettings = {
      selectedYears: [],
      type: 'line',
      showValues: false,
      periodType: 'monthly'
    };
    
    let tableSettings = {
      searchQuery: '',
      rowsPerPage: 25,
      visibleColumns: {
        'no': true,
        'periode': true,
        'pasien-masuk': true,
        'pasien-keluar': true,
        'pasien-dirawat': true,
        'jumlah-tt': true,
        'jumlah-hari': true,
        'hari-rawatan': true,
        'lama-dirawat': true,
        'meninggal-48': true,
        'meninggal-kurang-48': true,
        'total-meninggal': true,
        'bor': true,
        'avlos': true,
        'toi': true,
        'bto': true,
        'ndr': true,
        'gdr': true
      }
    };

    let bookmarks = [];

    // Theme Management
    function initTheme() {
      const savedTheme = localStorage.getItem('dashboard-theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeToggle(savedTheme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('dashboard-theme', newTheme);
      updateThemeToggle(newTheme);
      
      // Refresh charts untuk menyesuaikan warna
      if (Object.keys(charts).length > 0) {
        updateChartsWithSettings();
      }
      if (Object.keys(pelayananCharts).length > 0) {
        updatePelayananChartsWithSettings();
      }
    }

    function updateThemeToggle(theme) {
      const slider = document.querySelector('.theme-toggle-slider');
      slider.textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
    }

    // Bookmark Management
    function loadBookmarks() {
      const saved = localStorage.getItem('dashboard-bookmarks');
      if (saved) {
        bookmarks = JSON.parse(saved);
        renderBookmarks();
      }
    }

    function saveBookmark() {
      const name = document.getElementById('bookmark-name').value.trim();
      if (!name) {
        showMessage('âš ï¸ Mohon masukkan nama bookmark', 'warning');
        return;
      }

      const bookmark = {
        id: Date.now(),
        name: name,
        filter: currentFilter,
        customYear: document.getElementById('custom-year')?.value,
        customMonth: document.getElementById('custom-month')?.value,
        activeTab: document.querySelector('.tab-button.active')?.id.replace('tab-', ''),
        yearFilter: document.getElementById('year-filter')?.value,
        monthFilter: document.getElementById('month-filter')?.value,
        timestamp: new Date().toISOString()
      };

      bookmarks.push(bookmark);
      localStorage.setItem('dashboard-bookmarks', JSON.stringify(bookmarks));
      document.getElementById('bookmark-name').value = '';
      renderBookmarks();
      showMessage('âœ… Bookmark berhasil disimpan!', 'success');
    }

    function renderBookmarks() {
      const container = document.getElementById('bookmarks-list');
      if (bookmarks.length === 0) {
        container.innerHTML = '<p class="text-sm" style="color: var(--text-secondary);">Belum ada bookmark tersimpan</p>';
        return;
      }

      container.innerHTML = bookmarks.map(b => `
        <div class="bookmark-card p-4 rounded-lg">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1 cursor-pointer" onclick="loadBookmark(${b.id})">
              <h4 class="font-semibold mb-1" style="color: var(--text-primary);">${b.name}</h4>
              <p class="text-xs mb-1" style="color: var(--text-secondary);">
                ğŸ“… ${getFilterLabel(b.filter, b.customYear, b.customMonth)}
              </p>
              <p class="text-xs" style="color: var(--text-secondary);">
                Dibuat: ${new Date(b.timestamp).toLocaleDateString('id-ID', { 
                  day: 'numeric', 
                  month: 'short', 
                  year: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                })}
              </p>
            </div>
            <button onclick="deleteBookmark(${b.id})" class="text-red-500 hover:text-red-700 text-xl">
              ğŸ—‘ï¸
            </button>
          </div>
        </div>
      `).join('');
    }

    function getFilterLabel(filter, customYear, customMonth) {
      const monthNames = {
        'Jan': 'Januari', 'Feb': 'Februari', 'Mar': 'Maret', 'Apr': 'April',
        'Mei': 'Mei', 'Jun': 'Juni', 'Jul': 'Juli', 'Agu': 'Agustus',
        'Sep': 'September', 'Okt': 'Oktober', 'Nov': 'November', 'Des': 'Desember'
      };

      if (filter === 'bulan-ini') return 'Bulan Ini';
      if (filter === 'bulan-lalu') return 'Bulan Lalu';
      if (filter === 'tahun-ini') return 'Tahun Ini';
      if (filter === 'tahun-lalu') return 'Tahun Lalu';
      if (filter === 'custom') {
        if (customYear !== 'all' && customMonth !== 'all') {
          return `${monthNames[customMonth]} ${customYear}`;
        } else if (customYear !== 'all') {
          return `Tahun ${customYear}`;
        } else if (customMonth !== 'all') {
          return `Bulan ${monthNames[customMonth]}`;
        }
        return 'Custom Filter';
      }
      return filter;
    }

    function loadBookmark(id) {
      const bookmark = bookmarks.find(b => b.id === id);
      if (!bookmark) return;

      // Switch tab if needed
      if (bookmark.activeTab) {
        switchTab(bookmark.activeTab);
      }

      // Apply filters
      if (bookmark.filter === 'custom') {
        document.getElementById('custom-year').value = bookmark.customYear || 'all';
        document.getElementById('custom-month').value = bookmark.customMonth || 'all';
        setActiveFilter('custom');
        document.getElementById('custom-period-selector').style.display = 'grid';
        applyCustomFilter();
      } else {
        setActiveFilter(bookmark.filter);
        applyFilter(bookmark.filter);
      }

      // Apply tab-specific filters
      if (bookmark.yearFilter) {
        document.getElementById('year-filter').value = bookmark.yearFilter;
      }
      if (bookmark.monthFilter) {
        document.getElementById('month-filter').value = bookmark.monthFilter;
      }
      if (bookmark.activeTab !== 'dashboard') {
        applyOtherTabsFilter();
      }

      closeBookmarksPanel();
      showMessage(`ğŸ“š Bookmark "${bookmark.name}" diterapkan`, 'success');
    }

    function deleteBookmark(id) {
      if (!confirm('Hapus bookmark ini?')) return;
      
      bookmarks = bookmarks.filter(b => b.id !== id);
      localStorage.setItem('dashboard-bookmarks', JSON.stringify(bookmarks));
      renderBookmarks();
      showMessage('ğŸ—‘ï¸ Bookmark berhasil dihapus', 'info');
    }

    function openBookmarksPanel() {
      document.getElementById('bookmarks-panel').classList.add('active');
      document.getElementById('overlay').classList.add('active');
    }

    function closeBookmarksPanel() {
      document.getElementById('bookmarks-panel').classList.remove('active');
      document.getElementById('overlay').classList.remove('active');
    }

    // Print Functionality
    function printDashboard() {
      // Update print metadata
      document.getElementById('print-date').textContent = new Date().toLocaleDateString('id-ID', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('print-period').textContent = document.getElementById('current-period').textContent;

      // Trigger print
      window.print();
    }

    // Floating Action Button
    function setupFAB() {
      const fabMain = document.getElementById('fab-main');
      const fabMenu = document.getElementById('fab-menu');
      let menuOpen = false;

      fabMain.addEventListener('click', () => {
        menuOpen = !menuOpen;
        if (menuOpen) {
          fabMenu.classList.add('active');
          fabMain.style.transform = 'rotate(45deg)';
        } else {
          fabMenu.classList.remove('active');
          fabMain.style.transform = 'rotate(0deg)';
        }
      });

      document.getElementById('fab-bookmark').addEventListener('click', openBookmarksPanel);
      document.getElementById('fab-theme').addEventListener('click', toggleTheme);
      document.getElementById('fab-print').addEventListener('click', printDashboard);
    }

    // Message Toast
    function showMessage(text, type = 'info') {
      const colors = {
        success: 'bg-green-600',
        warning: 'bg-orange-600',
        error: 'bg-red-600',
        info: 'bg-blue-600'
      };

      const message = document.createElement('div');
      message.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-[9999] animate-slide-in`;
      message.style.animation = 'fadeInUp 0.3s ease';
      message.innerHTML = text;
      document.body.appendChild(message);
      setTimeout(() => {
        message.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => message.remove(), 300);
      }, 3000);
    }

    async function loadDataFromGoogleSheets() {
      const loadingIndicator = document.getElementById('loading-indicator');
      const errorIndicator = document.getElementById('error-indicator');
      
      try {
        loadingIndicator.style.display = 'flex';
        errorIndicator.style.display = 'none';

        const response = await fetch(GOOGLE_SHEETS_URL);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const csvText = await response.text();
        
        if (!csvText || csvText.trim().length === 0) {
          throw new Error('Data CSV kosong');
        }

        rawData = parseCSV(csvText);
        
        if (rawData.length === 0) {
          throw new Error('Data kosong atau format tidak sesuai');
        }

        loadingIndicator.style.display = 'none';
        
        initializeDashboard();
        setupEventListeners();
        initTheme();
        loadBookmarks();
        setupFAB();
        
      } catch (error) {
        console.error('âš ï¸ Error loading data:', error);
        loadingIndicator.style.display = 'none';
        errorIndicator.style.display = 'block';
        
        document.getElementById('error-status').textContent = error.name || 'Error';
        document.getElementById('error-message').textContent = error.message || 'Unknown error';
      }
    }

    function parseIndonesianNumber(str) {
      if (!str) return 0;
      const cleaned = str.toString().replace(/\./g, '').replace(',', '.');
      return parseFloat(cleaned) || 0;
    }

    function parseCSV(csv) {
      const lines = csv.trim().split('\n');
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let j = 0; j < lines[i].length; j++) {
          const char = lines[i][j];
          
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim());
        
        if (values.length < 17) continue;

        const periode = values[0];
        const isYearlyAggregate = periode.startsWith('Tahun');

        const row = {
          periode: periode,
          isYearlyAggregate: isYearlyAggregate,
          jlhPasienMasuk: parseIndonesianNumber(values[1]),
          jlhPasienKeluar: parseIndonesianNumber(values[2]),
          jlhPasienDirawat: parseIndonesianNumber(values[3]),
          jumlahTT: parseIndonesianNumber(values[4]),
          jumlahHari: parseIndonesianNumber(values[5]),
          hariRawatan: parseIndonesianNumber(values[6]),
          lamaDirawat: parseIndonesianNumber(values[7]),
          meninggal48: parseIndonesianNumber(values[8]),
          meninggalKurang48: parseIndonesianNumber(values[9]),
          pasienMeninggal: parseIndonesianNumber(values[10]),
          bor: parseIndonesianNumber(values[11]),
          avlos: parseIndonesianNumber(values[12]),
          toi: parseIndonesianNumber(values[13]),
          bto: parseIndonesianNumber(values[14]),
          ndr: parseIndonesianNumber(values[15]),
          gdr: parseIndonesianNumber(values[16])
        };

        data.push(row);
      }

      return data;
    }

    function getCurrentMonthYear() {
      const now = new Date();
      const monthMap = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
      return {
        month: monthMap[now.getMonth()],
        year: now.getFullYear().toString()
      };
    }

    function getLastMonthYear() {
      const now = new Date();
      now.setMonth(now.getMonth() - 1);
      const monthMap = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
      return {
        month: monthMap[now.getMonth()],
        year: now.getFullYear().toString()
      };
    }

    function initializeDashboard() {
      const years = [...new Set(rawData
        .filter(d => !d.isYearlyAggregate)
        .map(d => d.periode.split(' ')[1])
      )].sort();
      
      const customYearFilter = document.getElementById('custom-year');
      customYearFilter.innerHTML = '<option value="all">Semua Tahun</option>' +
        years.map(year => `<option value="${year}">${year}</option>`).join('');

      const yearFilter = document.getElementById('year-filter');
      yearFilter.innerHTML = '<option value="all">Semua Tahun</option>' +
        years.map(year => `<option value="${year}">${year}</option>`).join('');

      // Populate chart year checkboxes
      const chartYearCheckboxes = document.getElementById('chart-year-checkboxes');
      chartYearCheckboxes.innerHTML = years.map(year => `
        <label class="flex items-center gap-1 px-3 py-2 rounded-lg border cursor-pointer hover:bg-blue-50 transition-all" style="background: var(--bg-secondary); border-color: var(--border-color);">
          <input type="checkbox" value="${year}" class="year-checkbox w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer">
          <span class="text-sm font-medium" style="color: var(--text-primary);">${year}</span>
        </label>
      `).join('');

      // Initialize with all years selected
      chartSettings.selectedYears = [...years];
      document.querySelectorAll('.year-checkbox').forEach(cb => {
        cb.checked = true;
        cb.addEventListener('change', handleYearCheckboxChange);
      });

      // Populate pelayanan year checkboxes
      const pelayananYearCheckboxes = document.getElementById('pelayanan-year-checkboxes');
      pelayananYearCheckboxes.innerHTML = years.map(year => `
        <label class="flex items-center gap-1 px-3 py-2 rounded-lg border cursor-pointer hover:bg-blue-50 transition-all" style="background: var(--bg-secondary); border-color: var(--border-color);">
          <input type="checkbox" value="${year}" class="pelayanan-year-checkbox w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer">
          <span class="text-sm font-medium" style="color: var(--text-primary);">${year}</span>
        </label>
      `).join('');

      // Initialize pelayanan settings with all years selected
      pelayananSettings.selectedYears = [...years];
      document.querySelectorAll('.pelayanan-year-checkbox').forEach(cb => {
        cb.checked = true;
        cb.addEventListener('change', handlePelayananYearCheckboxChange);
      });

      applyFilter('bulan-ini');
      
      // Render charts with all data on first load
      updateChartsWithSettings();
    }

    function handleYearCheckboxChange() {
      const checkedYears = Array.from(document.querySelectorAll('.year-checkbox:checked'))
        .map(cb => cb.value);
      chartSettings.selectedYears = checkedYears;
      updateChartsWithSettings();
    }

    function handlePelayananYearCheckboxChange() {
      const checkedYears = Array.from(document.querySelectorAll('.pelayanan-year-checkbox:checked'))
        .map(cb => cb.value);
      pelayananSettings.selectedYears = checkedYears;
      updatePelayananChartsWithSettings();
    }

    function setupEventListeners() {
      // Quick Filter Buttons
      document.getElementById('filter-bulan-ini').addEventListener('click', () => {
        setActiveFilter('bulan-ini');
        applyFilter('bulan-ini');
      });

      document.getElementById('filter-bulan-lalu').addEventListener('click', () => {
        setActiveFilter('bulan-lalu');
        applyFilter('bulan-lalu');
      });

      document.getElementById('filter-tahun-ini').addEventListener('click', () => {
        setActiveFilter('tahun-ini');
        applyFilter('tahun-ini');
      });

      document.getElementById('filter-tahun-lalu').addEventListener('click', () => {
        setActiveFilter('tahun-lalu');
        applyFilter('tahun-lalu');
      });

      document.getElementById('filter-custom').addEventListener('click', () => {
        setActiveFilter('custom');
        document.getElementById('custom-period-selector').style.display = 'grid';
      });

      document.getElementById('apply-custom-filter').addEventListener('click', () => {
        applyCustomFilter();
      });

      // Tab Buttons
      document.getElementById('tab-dashboard').addEventListener('click', () => switchTab('dashboard'));
      document.getElementById('tab-pelayanan').addEventListener('click', () => switchTab('pelayanan'));
      document.getElementById('tab-mutu').addEventListener('click', () => switchTab('mutu'));

      // Other Tab Filters
      document.getElementById('year-filter').addEventListener('change', applyOtherTabsFilter);
      document.getElementById('month-filter').addEventListener('change', applyOtherTabsFilter);
      document.getElementById('reset-filter').addEventListener('click', () => {
        document.getElementById('year-filter').value = 'all';
        document.getElementById('month-filter').value = 'all';
        applyOtherTabsFilter();
      });

      // Export PDF / Print
      document.getElementById('export-pdf-btn').addEventListener('click', printDashboard);

      // Chart Controls
      document.getElementById('chart-type-selector').addEventListener('change', updateChartsWithSettings);
      document.getElementById('chart-show-values').addEventListener('change', (e) => {
        chartSettings.showValues = e.target.checked;
        updateChartsWithSettings();
      });
      document.getElementById('chart-period-type').addEventListener('change', updateChartsWithSettings);

      // Export Buttons
      document.getElementById('export-charts-png').addEventListener('click', () => exportCharts('png'));
      document.getElementById('export-charts-svg').addEventListener('click', () => exportCharts('svg'));
      document.getElementById('export-table-csv').addEventListener('click', () => exportTable('csv'));
      document.getElementById('export-table-excel').addEventListener('click', () => exportTable('excel'));
      document.getElementById('export-mortality-png').addEventListener('click', () => exportMortalityCharts('png'));
      document.getElementById('export-mortality-svg').addEventListener('click', () => exportMortalityCharts('svg'));

      // Pelayanan Chart Controls
      document.getElementById('pelayanan-chart-type').addEventListener('change', updatePelayananChartsWithSettings);
      document.getElementById('pelayanan-show-values').addEventListener('change', (e) => {
        pelayananSettings.showValues = e.target.checked;
        updatePelayananChartsWithSettings();
      });
      document.getElementById('pelayanan-period-type').addEventListener('change', updatePelayananChartsWithSettings);
      document.getElementById('export-pelayanan-png').addEventListener('click', () => exportPelayananCharts('png'));
      document.getElementById('export-pelayanan-svg').addEventListener('click', () => exportPelayananCharts('svg'));

      // Error handlers
      document.getElementById('retry-load-btn')?.addEventListener('click', () => {
        loadDataFromGoogleSheets();
      });

      document.getElementById('test-url-btn')?.addEventListener('click', () => {
        window.open(GOOGLE_SHEETS_URL, '_blank', 'noopener,noreferrer');
      });

      // Table Search
      document.getElementById('table-search').addEventListener('input', (e) => {
        tableSettings.searchQuery = e.target.value.toLowerCase();
        renderDataTable();
      });

      // Rows Per Page
      document.getElementById('rows-per-page').addEventListener('change', (e) => {
        tableSettings.rowsPerPage = e.target.value === 'all' ? 'all' : parseInt(e.target.value);
        renderDataTable();
      });

      // Column Selector
      document.getElementById('column-selector-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        const dropdown = document.getElementById('column-selector-dropdown');
        dropdown.classList.toggle('hidden');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('column-selector-dropdown');
        const btn = document.getElementById('column-selector-btn');
        if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
          dropdown.classList.add('hidden');
        }
      });

      // Select/Deselect All Columns
      document.getElementById('select-all-columns').addEventListener('click', () => {
        Object.keys(tableSettings.visibleColumns).forEach(col => {
          tableSettings.visibleColumns[col] = true;
        });
        updateColumnCheckboxes();
        renderDataTable();
      });

      document.getElementById('deselect-all-columns').addEventListener('click', () => {
        Object.keys(tableSettings.visibleColumns).forEach(col => {
          if (col !== 'no' && col !== 'periode') {
            tableSettings.visibleColumns[col] = false;
          }
        });
        updateColumnCheckboxes();
        renderDataTable();
      });

      // Theme Toggle
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

      // Bookmarks
      document.getElementById('bookmarks-btn').addEventListener('click', openBookmarksPanel);
      document.getElementById('close-bookmarks').addEventListener('click', closeBookmarksPanel);
      document.getElementById('overlay').addEventListener('click', closeBookmarksPanel);
      document.getElementById('save-bookmark').addEventListener('click', saveBookmark);
    }

    function setActiveFilter(filterId) {
      document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'rgba(255, 255, 255, 0.5)';
        btn.style.color = 'white';
      });

      if (filterId === 'bulan-ini') {
        document.getElementById('filter-bulan-ini').classList.add('active');
      } else if (filterId === 'bulan-lalu') {
        document.getElementById('filter-bulan-lalu').classList.add('active');
      } else if (filterId === 'tahun-ini') {
        document.getElementById('filter-tahun-ini').classList.add('active');
      } else if (filterId === 'tahun-lalu') {
        document.getElementById('filter-tahun-lalu').classList.add('active');
      } else if (filterId === 'custom') {
        document.getElementById('filter-custom').classList.add('active');
      }

      if (filterId !== 'custom') {
        document.getElementById('custom-period-selector').style.display = 'none';
      }
    }

    function applyFilter(filterType) {
      currentFilter = filterType;
      let filtered = [];
      const current = getCurrentMonthYear();
      const lastMonth = getLastMonthYear();
      const currentYear = current.year;
      const lastYear = (parseInt(currentYear) - 1).toString();

      if (filterType === 'bulan-ini') {
        filtered = rawData.filter(d => {
          const parts = d.periode.split(' ');
          return parts.length === 2 && parts[0] === current.month && parts[1] === current.year && !d.isYearlyAggregate;
        });
      } else if (filterType === 'bulan-lalu') {
        filtered = rawData.filter(d => {
          const parts = d.periode.split(' ');
          return parts.length === 2 && parts[0] === lastMonth.month && parts[1] === lastMonth.year && !d.isYearlyAggregate;
        });
      } else if (filterType === 'tahun-ini') {
        const yearAggregate = rawData.find(d => d.periode === `Tahun ${currentYear}` && d.isYearlyAggregate);
        if (yearAggregate) {
          filtered = [yearAggregate];
        } else {
          filtered = rawData.filter(d => {
            const parts = d.periode.split(' ');
            return parts.length === 2 && parts[1] === currentYear && !d.isYearlyAggregate;
          });
        }
      } else if (filterType === 'tahun-lalu') {
        const yearAggregate = rawData.find(d => d.periode === `Tahun ${lastYear}` && d.isYearlyAggregate);
        if (yearAggregate) {
          filtered = [yearAggregate];
        } else {
          filtered = rawData.filter(d => {
            const parts = d.periode.split(' ');
            return parts.length === 2 && parts[1] === lastYear && !d.isYearlyAggregate;
          });
        }
      }

      updateMetrics(filtered, filterType);
      updateCharts(filtered);
      generateInsights(filtered);
    }

    function applyCustomFilter() {
      const year = document.getElementById('custom-year').value;
      const month = document.getElementById('custom-month').value;

      let filtered = rawData.filter(d => !d.isYearlyAggregate);

      if (year !== 'all') {
        filtered = filtered.filter(d => {
          const parts = d.periode.split(' ');
          return parts.length === 2 && parts[1] === year;
        });
      }

      if (month !== 'all') {
        filtered = filtered.filter(d => {
          const parts = d.periode.split(' ');
          return parts.length === 2 && parts[0] === month;
        });
      }

      updateMetrics(filtered, 'custom');
      updateCharts(filtered);
      generateInsights(filtered);
    }

    function updateMetrics(filtered, filterType) {
      const cardPeriodInfo = document.getElementById('card-period-info');
      const currentPeriod = document.getElementById('current-period');
      
      if (filtered.length === 0) {
        cardPeriodInfo.textContent = 'Tidak ada data untuk periode yang dipilih';
        currentPeriod.textContent = 'Tidak ada data';
        document.getElementById('bor-value').textContent = '--';
        document.getElementById('avlos-value').textContent = '--';
        document.getElementById('toi-value').textContent = '--';
        document.getElementById('bto-value').textContent = '--';
        document.getElementById('ndr-value').textContent = '--';
        document.getElementById('gdr-value').textContent = '--';
        return;
      }

      const monthNames = {
        'Jan': 'Januari', 'Feb': 'Februari', 'Mar': 'Maret', 'Apr': 'April',
        'Mei': 'Mei', 'Jun': 'Juni', 'Jul': 'Juli', 'Agu': 'Agustus',
        'Sep': 'September', 'Okt': 'Oktober', 'Nov': 'November', 'Des': 'Desember'
      };

      let periodText = '';
      if (filterType === 'bulan-ini') {
        const current = getCurrentMonthYear();
        periodText = `${monthNames[current.month]} ${current.year}`;
      } else if (filterType === 'bulan-lalu') {
        const lastMonth = getLastMonthYear();
        periodText = `${monthNames[lastMonth.month]} ${lastMonth.year}`;
      } else if (filterType === 'tahun-ini') {
        periodText = `Tahun ${getCurrentMonthYear().year}`;
      } else if (filterType === 'tahun-lalu') {
        periodText = `Tahun ${parseInt(getCurrentMonthYear().year) - 1}`;
      } else if (filterType === 'custom') {
        const year = document.getElementById('custom-year').value;
        const month = document.getElementById('custom-month').value;
        if (year !== 'all' && month !== 'all') {
          periodText = `${monthNames[month]} ${year}`;
        } else if (year !== 'all') {
          periodText = `Tahun ${year}`;
        } else if (month !== 'all') {
          periodText = `Bulan ${monthNames[month]} (Semua Tahun)`;
        } else {
          periodText = 'Semua Data';
        }
      }
      
      cardPeriodInfo.textContent = periodText;
      currentPeriod.textContent = periodText;
      
      const bor = (filtered.reduce((sum, d) => sum + d.bor, 0) / filtered.length).toFixed(2);
      const avlos = (filtered.reduce((sum, d) => sum + d.avlos, 0) / filtered.length).toFixed(2);
      const toi = (filtered.reduce((sum, d) => sum + d.toi, 0) / filtered.length).toFixed(2);
      const bto = (filtered.reduce((sum, d) => sum + d.bto, 0) / filtered.length).toFixed(2);
      const ndr = (filtered.reduce((sum, d) => sum + d.ndr, 0) / filtered.length).toFixed(2);
      const gdr = (filtered.reduce((sum, d) => sum + d.gdr, 0) / filtered.length).toFixed(2);

      document.getElementById('bor-value').textContent = bor + '%';
      document.getElementById('avlos-value').textContent = avlos;
      document.getElementById('toi-value').textContent = toi;
      document.getElementById('bto-value').textContent = bto;
      document.getElementById('ndr-value').textContent = ndr + 'â€°';
      document.getElementById('gdr-value').textContent = gdr + 'â€°';

      updateStatusIndicators(bor, avlos, toi, bto, ndr, gdr);
    }

    function updateChartsWithSettings() {
      chartSettings.type = document.getElementById('chart-type-selector').value;
      chartSettings.periodType = document.getElementById('chart-period-type').value;

      let chartData = [];

      if (chartSettings.periodType === 'yearly') {
        chartData = rawData.filter(d => d.isYearlyAggregate);
        
        if (chartSettings.selectedYears.length > 0) {
          chartData = chartData.filter(d => {
            const year = d.periode.replace('Tahun ', '');
            return chartSettings.selectedYears.includes(year);
          });
        }
      } else {
        chartData = rawData.filter(d => !d.isYearlyAggregate);

        if (chartSettings.selectedYears.length > 0) {
          chartData = chartData.filter(d => {
            const parts = d.periode.split(' ');
            return parts.length === 2 && chartSettings.selectedYears.includes(parts[1]);
          });
        }
      }

      updateCharts(chartData);
    }

    function updateStatusIndicators(bor, avlos, toi, bto, ndr, gdr) {
      const borStatus = document.getElementById('bor-status');
      const borIconBg = document.getElementById('bor-icon-bg');
      if (bor >= 60 && bor <= 85) {
        borStatus.style.background = '#10b981';
        borIconBg.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
      } else if (bor > 85 && bor <= 100) {
        borStatus.style.background = '#f59e0b';
        borIconBg.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
      } else {
        borStatus.style.background = '#ef4444';
        borIconBg.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
      }

      const avlosStatus = document.getElementById('avlos-status');
      const avlosIconBg = document.getElementById('avlos-icon-bg');
      if (avlos >= 6 && avlos <= 9) {
        avlosStatus.style.background = '#10b981';
        avlosIconBg.style.background = 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)';
      } else {
        avlosStatus.style.background = '#f59e0b';
        avlosIconBg.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
      }

      const toiStatus = document.getElementById('toi-status');
      const toiIconBg = document.getElementById('toi-icon-bg');
      if (toi >= 1 && toi <= 3) {
        toiStatus.style.background = '#10b981';
        toiIconBg.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
      } else {
        toiStatus.style.background = '#f59e0b';
        toiIconBg.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
      }

      const btoStatus = document.getElementById('bto-status');
      const btoIconBg = document.getElementById('bto-icon-bg');
      if (bto >= 40 && bto <= 50) {
        btoStatus.style.background = '#10b981';
        btoIconBg.style.background = 'linear-gradient(135deg, #fed7aa 0%, #fdba74 100%)';
      } else {
        btoStatus.style.background = '#ef4444';
        btoIconBg.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
      }

      document.getElementById('ndr-status').style.background = ndr <= 25 ? '#10b981' : '#ef4444';
      document.getElementById('ndr-icon-bg').style.background = 'linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%)';
      
      document.getElementById('gdr-status').style.background = gdr < 45 ? '#10b981' : '#ef4444';
      document.getElementById('gdr-icon-bg').style.background = 'linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%)';
    }

    function updateCharts(filtered) {
      if (filtered.length === 0) return;

      const labels = filtered.map(d => d.periode);
      
      const chartType = chartSettings.type;
      const showValues = chartSettings.showValues;

      // Chart BOR & AVLOS
      if (charts.borAvlos) charts.borAvlos.destroy();
      const ctxBorAvlos = document.getElementById('chart-bor-avlos').getContext('2d');
      
      const borData = filtered.map(d => d.bor);
      const avlosData = filtered.map(d => d.avlos);
      
      charts.borAvlos = new Chart(ctxBorAvlos, {
        type: chartType,
        data: { 
          labels: labels, 
          datasets: [{
            label: 'BOR (%)',
            data: borData,
            borderColor: '#3b82f6',
            backgroundColor: chartType === 'bar' ? 'rgba(59, 130, 246, 0.7)' : 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            yAxisID: 'y',
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#1e40af',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value ? value.toFixed(1) : ''
            }
          }, {
            label: 'AVLOS (hari)',
            data: avlosData,
            borderColor: '#10b981',
            backgroundColor: chartType === 'bar' ? 'rgba(16, 185, 129, 0.7)' : 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            yAxisID: 'y1',
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#047857',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value ? value.toFixed(1) : ''
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: { mode: 'index', intersect: false },
          plugins: { 
            legend: { position: 'top' }
          },
          scales: {
            x: { 
              grid: { display: false }
            },
            y: { 
              type: 'linear', 
              display: true, 
              position: 'left', 
              title: { display: true, text: 'BOR (%)' },
              grid: { color: 'rgba(0, 0, 0, 0.05)', drawTicks: false }
            },
            y1: { 
              type: 'linear', 
              display: true, 
              position: 'right', 
              title: { display: true, text: 'AVLOS (hari)' }, 
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      // Chart TOI & BTO
      if (charts.toiBto) charts.toiBto.destroy();
      const ctxToiBto = document.getElementById('chart-toi-bto').getContext('2d');
      
      const toiData = filtered.map(d => d.toi);
      const btoData = filtered.map(d => d.bto);
      
      charts.toiBto = new Chart(ctxToiBto, {
        type: chartType,
        data: { 
          labels: labels, 
          datasets: [{
            label: 'TOI (hari)',
            data: toiData,
            borderColor: '#f59e0b',
            backgroundColor: chartType === 'bar' ? 'rgba(245, 158, 11, 0.7)' : 'rgba(245, 158, 11, 0.1)',
            tension: 0.4,
            yAxisID: 'y',
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#b45309',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value ? value.toFixed(1) : ''
            }
          }, {
            label: 'BTO (kali)',
            data: btoData,
            borderColor: '#8b5cf6',
            backgroundColor: chartType === 'bar' ? 'rgba(139, 92, 246, 0.7)' : 'rgba(139, 92, 246, 0.1)',
            tension: 0.4,
            yAxisID: 'y1',
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#5b21b6',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value ? value.toFixed(1) : ''
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: { mode: 'index', intersect: false },
          plugins: { 
            legend: { position: 'top' }
          },
          scales: {
            x: { 
              grid: { display: false }
            },
            y: { 
              type: 'linear', 
              display: true, 
              position: 'left', 
              title: { display: true, text: 'TOI (hari)' },
              grid: { color: 'rgba(0, 0, 0, 0.05)', drawTicks: false }
            },
            y1: { 
              type: 'linear', 
              display: true, 
              position: 'right', 
              title: { display: true, text: 'BTO (kali)' }, 
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      // Chart NDR & GDR
      if (charts.ndrGdr) charts.ndrGdr.destroy();
      const ctxNdrGdr = document.getElementById('chart-ndr-gdr').getContext('2d');
      
      const ndrData = filtered.map(d => d.ndr);
      const gdrData = filtered.map(d => d.gdr);
      
      charts.ndrGdr = new Chart(ctxNdrGdr, {
        type: chartType,
        data: { 
          labels: labels, 
          datasets: [{
            label: 'NDR (â€°)',
            data: ndrData,
            borderColor: '#ef4444',
            backgroundColor: chartType === 'bar' ? 'rgba(239, 68, 68, 0.7)' : 'rgba(239, 68, 68, 0.1)',
            tension: 0.4,
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#b91c1c',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value ? value.toFixed(1) : ''
            }
          }, {
            label: 'GDR (â€°)',
            data: gdrData,
            borderColor: '#ec4899',
            backgroundColor: chartType === 'bar' ? 'rgba(236, 72, 153, 0.7)' : 'rgba(236, 72, 153, 0.1)',
            tension: 0.4,
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#9f1239',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value ? value.toFixed(1) : ''
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: { mode: 'index', intersect: false },
          plugins: { 
            legend: { position: 'top' }
          },
          scales: {
            x: { 
              grid: { display: false }
            },
            y: { 
              grid: { color: 'rgba(0, 0, 0, 0.05)', drawTicks: false }
            }
          }
        }
      });

      // Chart Pasien
      if (charts.pasien) charts.pasien.destroy();
      const ctxPasien = document.getElementById('chart-pasien').getContext('2d');
      
      const pasienMasukData = filtered.map(d => d.jlhPasienMasuk);
      const pasienKeluarData = filtered.map(d => d.jlhPasienKeluar);

      charts.pasien = new Chart(ctxPasien, {
        type: chartType === 'line' ? 'bar' : chartType,
        data: { 
          labels: labels, 
          datasets: [{
            label: 'Pasien Masuk',
            data: pasienMasukData,
            backgroundColor: 'rgba(59, 130, 246, 0.7)',
            borderColor: '#3b82f6',
            borderWidth: 1,
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#1e40af',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value || ''
            }
          }, {
            label: 'Pasien Keluar',
            data: pasienKeluarData,
            backgroundColor: 'rgba(16, 185, 129, 0.7)',
            borderColor: '#10b981',
            borderWidth: 1,
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#047857',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value || ''
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { 
            legend: { position: 'top' }
          },
          scales: {
            x: { 
              grid: { display: false }
            },
            y: { 
              grid: { color: 'rgba(0, 0, 0, 0.05)', drawTicks: false }
            }
          }
        }
      });
    }

    function generateInsights(filtered) {
      if (filtered.length === 0) {
        document.getElementById('insights-container').innerHTML = '<div class="insight-box p-4 rounded-lg"><p class="text-sm" style="color: var(--text-primary);">Tidak ada data untuk generate insight</p></div>';
        return;
      }

      const avgBor = filtered.reduce((sum, d) => sum + d.bor, 0) / filtered.length;
      const avgAvlos = filtered.reduce((sum, d) => sum + d.avlos, 0) / filtered.length;
      const avgToi = filtered.reduce((sum, d) => sum + d.toi, 0) / filtered.length;
      const avgBto = filtered.reduce((sum, d) => sum + d.bto, 0) / filtered.length;
      const avgNdr = filtered.reduce((sum, d) => sum + d.ndr, 0) / filtered.length;
      const avgGdr = filtered.reduce((sum, d) => sum + d.gdr, 0) / filtered.length;

      let insights = [];

      if (avgBor >= 60 && avgBor <= 85) {
        insights.push(`âœ… <strong>BOR Optimal:</strong> Rata-rata BOR ${avgBor.toFixed(2)}% berada dalam target ideal (60-85%). Efisiensi pemanfaatan tempat tidur sudah baik.`);
      } else if (avgBor < 60) {
        insights.push(`âš ï¸ <strong>BOR Rendah:</strong> Rata-rata BOR ${avgBor.toFixed(2)}% di bawah target. Pertimbangkan strategi peningkatan utilisasi tempat tidur.`);
      } else {
        insights.push(`âš ï¸ <strong>BOR Tinggi:</strong> Rata-rata BOR ${avgBor.toFixed(2)}% di atas target. Perhatikan risiko overcapacity dan kualitas pelayanan.`);
      }

      if (avgAvlos >= 6 && avgAvlos <= 9) {
        insights.push(`âœ… <strong>AVLOS Sesuai Target:</strong> Rata-rata lama rawat ${avgAvlos.toFixed(2)} hari sudah sesuai standar (6-9 hari).`);
      } else if (avgAvlos < 6) {
        insights.push(`ğŸ’¡ <strong>AVLOS Pendek:</strong> Rata-rata lama rawat ${avgAvlos.toFixed(2)} hari. Pastikan kualitas pelayanan tetap optimal.`);
      } else {
        insights.push(`âš ï¸ <strong>AVLOS Panjang:</strong> Rata-rata lama rawat ${avgAvlos.toFixed(2)} hari melebihi target. Evaluasi proses perawatan dan discharge planning.`);
      }

      if (avgToi >= 1 && avgToi <= 3) {
        insights.push(`âœ… <strong>TOI Optimal:</strong> Interval kosong tempat tidur ${avgToi.toFixed(2)} hari sudah ideal.`);
      }

      if (avgBto >= 40 && avgBto <= 50) {
        insights.push(`âœ… <strong>BTO Baik:</strong> Perputaran tempat tidur ${avgBto.toFixed(2)} kali/periode sudah sesuai target.`);
      } else if (avgBto < 40) {
        insights.push(`ğŸ’¡ <strong>BTO Rendah:</strong> Perputaran tempat tidur ${avgBto.toFixed(2)} kali. Ada peluang meningkatkan throughput pasien.`);
      }

      if (avgNdr <= 25) {
        insights.push(`âœ… <strong>NDR Baik:</strong> Rata-rata NDR ${avgNdr.toFixed(2)}â€° berada di bawah batas maksimal (â‰¤25â€°). Kualitas perawatan sudah baik.`);
      } else {
        insights.push(`âš ï¸ <strong>NDR Tinggi:</strong> Rata-rata NDR ${avgNdr.toFixed(2)}â€° melebihi target (â‰¤25â€°). Evaluasi protokol perawatan dan patient safety diperlukan.`);
      }

      if (avgGdr < 45) {
        insights.push(`âœ… <strong>GDR Baik:</strong> Rata-rata GDR ${avgGdr.toFixed(2)}â€° berada di bawah batas maksimal (<45â€°).`);
      } else {
        insights.push(`âš ï¸ <strong>GDR Tinggi:</strong> Rata-rata GDR ${avgGdr.toFixed(2)}â€° melebihi target (<45â€°). Perlu perhatian khusus pada manajemen kematian pasien.`);
      }

      const insightsHtml = insights.map(i => `<div class="insight-box p-4 rounded-lg"><p class="text-sm" style="color: var(--text-primary);">${i}</p></div>`).join('');
      document.getElementById('insights-container').innerHTML = insightsHtml;
    }

    function switchTab(tabName) {
      // Update Tab Buttons with smooth animation
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // Update Tab Content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
      });

      // Show Selected Tab with animation
      document.getElementById(`tab-${tabName}`).classList.add('active');
      document.getElementById(`content-${tabName}`).classList.add('active');
      document.getElementById(`content-${tabName}`).style.display = 'block';

      // Show/Hide Filters
      if (tabName === 'dashboard') {
        document.getElementById('dashboard-filters').style.display = 'block';
        document.getElementById('other-tabs-filters').style.display = 'none';
      } else {
        document.getElementById('dashboard-filters').style.display = 'none';
        document.getElementById('other-tabs-filters').style.display = 'grid';
        
        if (tabName === 'pelayanan') {
          renderDataTable();
          updatePelayananChartsWithSettings();
        } else if (tabName === 'mutu') {
          renderMortalityCharts();
        }
      }
    }

    function applyOtherTabsFilter() {
      const year = document.getElementById('year-filter').value;
      const month = document.getElementById('month-filter').value;

      let filtered = rawData.filter(d => !d.isYearlyAggregate);

      if (year !== 'all') {
        filtered = filtered.filter(d => {
          const parts = d.periode.split(' ');
          return parts.length === 2 && parts[1] === year;
        });
      }

      if (month !== 'all') {
        filtered = filtered.filter(d => {
          const parts = d.periode.split(' ');
          return parts.length === 2 && parts[0] === month;
        });
      }

      const activeTab = document.querySelector('.tab-button.active').id;
      if (activeTab === 'tab-pelayanan') {
        renderDataTable(filtered);
        updatePelayananChartsWithSettings();
      } else if (activeTab === 'tab-mutu') {
        renderMortalityCharts(filtered);
      }
    }

    function updatePelayananChartsWithSettings() {
      pelayananSettings.type = document.getElementById('pelayanan-chart-type').value;
      pelayananSettings.periodType = document.getElementById('pelayanan-period-type').value;

      let chartData = [];

      if (pelayananSettings.periodType === 'yearly') {
        chartData = rawData.filter(d => d.isYearlyAggregate);
        
        if (pelayananSettings.selectedYears.length > 0) {
          chartData = chartData.filter(d => {
            const year = d.periode.replace('Tahun ', '');
            return pelayananSettings.selectedYears.includes(year);
          });
        }
      } else {
        chartData = rawData.filter(d => !d.isYearlyAggregate);

        if (pelayananSettings.selectedYears.length > 0) {
          chartData = chartData.filter(d => {
            const parts = d.periode.split(' ');
            return parts.length === 2 && pelayananSettings.selectedYears.includes(parts[1]);
          });
        }
      }

      renderPelayananCharts(chartData);
    }

    function renderPelayananCharts(data = null) {
      const filtered = data || rawData.filter(d => !d.isYearlyAggregate);
      const labels = filtered.map(d => d.periode);
      
      const chartType = pelayananSettings.type;
      const showValues = pelayananSettings.showValues;

      // Chart 1: Tren Pasien Rawat Inap (Masuk, Keluar, Dirawat)
      if (pelayananCharts.pasien) pelayananCharts.pasien.destroy();
      const ctxPasien = document.getElementById('chart-pelayanan-pasien').getContext('2d');
      
      pelayananCharts.pasien = new Chart(ctxPasien, {
        type: chartType,
        data: {
          labels: labels,
          datasets: [{
            label: 'Pasien Masuk',
            data: filtered.map(d => d.jlhPasienMasuk),
            borderColor: '#3b82f6',
            backgroundColor: chartType === 'bar' ? 'rgba(59, 130, 246, 0.7)' : 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#1e40af',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value || ''
            }
          }, {
            label: 'Pasien Keluar',
            data: filtered.map(d => d.jlhPasienKeluar),
            borderColor: '#10b981',
            backgroundColor: chartType === 'bar' ? 'rgba(16, 185, 129, 0.7)' : 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#047857',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value || ''
            }
          }, {
            label: 'Pasien Dirawat',
            data: filtered.map(d => d.jlhPasienDirawat),
            borderColor: '#f59e0b',
            backgroundColor: chartType === 'bar' ? 'rgba(245, 158, 11, 0.7)' : 'rgba(245, 158, 11, 0.1)',
            tension: 0.4,
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#b45309',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value || ''
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { 
            legend: { position: 'top' }
          },
          scales: {
            x: { 
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Jumlah Pasien' },
              grid: { color: 'rgba(0, 0, 0, 0.05)', drawTicks: false }
            }
          }
        }
      });

      // Chart 2: BOR dan Kapasitas Tempat Tidur
      if (pelayananCharts.borKapasitas) pelayananCharts.borKapasitas.destroy();
      const ctxBorKapasitas = document.getElementById('chart-pelayanan-bor-kapasitas').getContext('2d');
      
      pelayananCharts.borKapasitas = new Chart(ctxBorKapasitas, {
        type: chartType,
        data: {
          labels: labels,
          datasets: [{
            label: 'BOR (%)',
            data: filtered.map(d => d.bor),
            borderColor: '#8b5cf6',
            backgroundColor: chartType === 'bar' ? 'rgba(139, 92, 246, 0.7)' : 'rgba(139, 92, 246, 0.1)',
            tension: 0.4,
            yAxisID: 'y',
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#5b21b6',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value ? value.toFixed(1) + '%' : ''
            }
          }, {
            label: 'Jumlah Tempat Tidur',
            data: filtered.map(d => d.jumlahTT),
            borderColor: '#06b6d4',
            backgroundColor: chartType === 'bar' ? 'rgba(6, 182, 212, 0.7)' : 'rgba(6, 182, 212, 0.1)',
            tension: 0.4,
            yAxisID: 'y1',
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#0e7490',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value || ''
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: { mode: 'index', intersect: false },
          plugins: { 
            legend: { position: 'top' }
          },
          scales: {
            x: { 
              grid: { display: false }
            },
            y: { 
              type: 'linear', 
              display: true, 
              position: 'left',
              title: { display: true, text: 'BOR (%)' },
              grid: { color: 'rgba(0, 0, 0, 0.05)', drawTicks: false }
            },
            y1: { 
              type: 'linear', 
              display: true, 
              position: 'right',
              title: { display: true, text: 'Jumlah TT' },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      // Chart 3: Tren Hari Rawatan dan Lama Dirawat
      if (pelayananCharts.rawatan) pelayananCharts.rawatan.destroy();
      const ctxRawatan = document.getElementById('chart-pelayanan-rawatan').getContext('2d');
      
      pelayananCharts.rawatan = new Chart(ctxRawatan, {
        type: chartType,
        data: {
          labels: labels,
          datasets: [{
            label: 'Hari Rawatan (Total)',
            data: filtered.map(d => d.hariRawatan),
            borderColor: '#ef4444',
            backgroundColor: chartType === 'bar' ? 'rgba(239, 68, 68, 0.7)' : 'rgba(239, 68, 68, 0.1)',
            tension: 0.4,
            yAxisID: 'y',
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#b91c1c',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value || ''
            }
          }, {
            label: 'Lama Dirawat (Total)',
            data: filtered.map(d => d.lamaDirawat),
            borderColor: '#ec4899',
            backgroundColor: chartType === 'bar' ? 'rgba(236, 72, 153, 0.7)' : 'rgba(236, 72, 153, 0.1)',
            tension: 0.4,
            yAxisID: 'y',
            datalabels: {
              display: showValues,
              align: 'top',
              color: '#9f1239',
              font: { size: 10, weight: 'bold' },
              formatter: (value) => value || ''
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { 
            legend: { position: 'top' }
          },
          scales: {
            x: { 
              grid: { display: false }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Total Hari' },
              grid: { color: 'rgba(0, 0, 0, 0.05)', drawTicks: false }
            }
          }
        }
      });
    }

    function renderDataTable(data = null) {
      const year = document.getElementById('year-filter').value;
      const month = document.getElementById('month-filter').value;

      // Include both monthly data AND yearly aggregates (akumulasi tahunan)
      let filtered = data || rawData;

      if (year !== 'all') {
        filtered = filtered.filter(d => {
          if (d.isYearlyAggregate) {
            // For yearly aggregates like "Tahun 2024"
            const yearFromPeriode = d.periode.replace('Tahun ', '');
            return yearFromPeriode === year;
          } else {
            // For monthly data like "Jan 2024"
            const parts = d.periode.split(' ');
            return parts.length === 2 && parts[1] === year;
          }
        });
      }

      if (month !== 'all') {
        // When filtering by specific month, exclude yearly aggregates
        filtered = filtered.filter(d => {
          if (d.isYearlyAggregate) return false;
          const parts = d.periode.split(' ');
          return parts.length === 2 && parts[0] === month;
        });
      }

      // Apply search filter
      if (tableSettings.searchQuery) {
        filtered = filtered.filter(d => {
          const searchStr = `${d.periode} ${d.bor} ${d.avlos} ${d.toi} ${d.bto} ${d.ndr} ${d.gdr} ${d.jlhPasienMasuk} ${d.jlhPasienKeluar}`.toLowerCase();
          return searchStr.includes(tableSettings.searchQuery);
        });
      }

      // Store total filtered count before pagination
      const totalFiltered = filtered.length;

      // Apply rows per page limit
      if (tableSettings.rowsPerPage !== 'all') {
        filtered = filtered.slice(0, tableSettings.rowsPerPage);
      }

      // Update counters
      document.getElementById('displayed-rows').textContent = filtered.length;
      document.getElementById('total-rows').textContent = totalFiltered;
      
      // Show filter badge
      const filterBadge = document.getElementById('filter-badge');
      if (tableSettings.searchQuery) {
        filterBadge.classList.remove('hidden');
      } else {
        filterBadge.classList.add('hidden');
      }

      const tbody = document.getElementById('data-table-body');
      
      const theme = document.documentElement.getAttribute('data-theme');
      const isDark = theme === 'dark';
      
      tbody.innerHTML = filtered.map((d, index) => {
        // Special styling for yearly aggregate rows (Tahun 2024, etc.)
        let rowClass, textColor, fontWeight;
        if (d.isYearlyAggregate) {
          rowClass = isDark ? 'bg-gray-700' : 'bg-gray-100';
          textColor = isDark ? 'text-gray-100' : 'text-gray-900';
          fontWeight = 'font-semibold';
        } else {
          rowClass = index % 2 === 0 ? (isDark ? 'bg-gray-800' : 'bg-white') : (isDark ? 'bg-gray-750' : 'bg-blue-50');
          textColor = isDark ? 'text-gray-300' : 'text-gray-700';
          fontWeight = 'font-normal';
        }
        
        const hoverClass = isDark ? 'hover:bg-gray-600' : (d.isYearlyAggregate ? 'hover:bg-gray-200' : 'hover:bg-blue-100');
        const stickyBg = d.isYearlyAggregate ? rowClass : rowClass;
        
        return `
        <tr class="${rowClass} ${hoverClass} transition-colors">
          <td class="px-3 py-3 text-center ${fontWeight} ${textColor} sticky left-0 ${stickyBg} z-10" ${tableSettings.visibleColumns['no'] ? '' : 'style="display:none;"'}>${d.isYearlyAggregate ? '' : index + 1}</td>
          <td class="px-4 py-3 ${fontWeight} ${textColor} sticky left-[60px] ${stickyBg} z-10" ${tableSettings.visibleColumns['periode'] ? '' : 'style="display:none;"'}>${d.periode}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['pasien-masuk'] ? '' : 'style="display:none;"'}>${d.jlhPasienMasuk}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['pasien-keluar'] ? '' : 'style="display:none;"'}>${d.jlhPasienKeluar}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['pasien-dirawat'] ? '' : 'style="display:none;"'}>${d.jlhPasienDirawat}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['jumlah-tt'] ? '' : 'style="display:none;"'}>${d.jumlahTT}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['jumlah-hari'] ? '' : 'style="display:none;"'}>${d.jumlahHari}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['hari-rawatan'] ? '' : 'style="display:none;"'}>${d.hariRawatan}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['lama-dirawat'] ? '' : 'style="display:none;"'}>${d.lamaDirawat}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['meninggal-48'] ? '' : 'style="display:none;"'}>${d.meninggal48}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['meninggal-kurang-48'] ? '' : 'style="display:none;"'}>${d.meninggalKurang48}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['total-meninggal'] ? '' : 'style="display:none;"'}>${d.pasienMeninggal}</td>
          <td class="px-4 py-3 text-right ${fontWeight} ${textColor}" ${tableSettings.visibleColumns['bor'] ? '' : 'style="display:none;"'}>${d.bor.toFixed(2)}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['avlos'] ? '' : 'style="display:none;"'}>${d.avlos.toFixed(2)}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['toi'] ? '' : 'style="display:none;"'}>${d.toi.toFixed(2)}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['bto'] ? '' : 'style="display:none;"'}>${d.bto.toFixed(2)}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['ndr'] ? '' : 'style="display:none;"'}>${d.ndr.toFixed(2)}</td>
          <td class="px-4 py-3 text-right ${textColor} ${fontWeight}" ${tableSettings.visibleColumns['gdr'] ? '' : 'style="display:none;"'}>${d.gdr.toFixed(2)}</td>
        </tr>
      `}).join('');

      // Update table headers visibility
      document.querySelectorAll('#data-table thead th').forEach(th => {
        const column = th.getAttribute('data-column');
        if (column && tableSettings.visibleColumns[column] !== undefined) {
          th.style.display = tableSettings.visibleColumns[column] ? '' : 'none';
        }
      });

      // Initialize column checkboxes if not already done
      initializeColumnCheckboxes();
    }

    function initializeColumnCheckboxes() {
      const container = document.getElementById('column-checkboxes-container');
      if (container.children.length > 0) return; // Already initialized

      const columns = [
        { id: 'no', label: 'No', disabled: true },
        { id: 'periode', label: 'Periode', disabled: true },
        { id: 'pasien-masuk', label: 'Pasien Masuk' },
        { id: 'pasien-keluar', label: 'Pasien Keluar' },
        { id: 'pasien-dirawat', label: 'Pasien Dirawat' },
        { id: 'jumlah-tt', label: 'Jumlah TT' },
        { id: 'jumlah-hari', label: 'Jumlah Hari' },
        { id: 'hari-rawatan', label: 'Hari Rawatan' },
        { id: 'lama-dirawat', label: 'Lama Dirawat' },
        { id: 'meninggal-48', label: 'Meninggal â‰¥48 Jam' },
        { id: 'meninggal-kurang-48', label: 'Meninggal <48 Jam' },
        { id: 'total-meninggal', label: 'Total Meninggal' },
        { id: 'bor', label: 'BOR (%)' },
        { id: 'avlos', label: 'AVLOS' },
        { id: 'toi', label: 'TOI' },
        { id: 'bto', label: 'BTO' },
        { id: 'ndr', label: 'NDR (â€°)' },
        { id: 'gdr', label: 'GDR (â€°)' }
      ];

      container.innerHTML = columns.map(col => `
        <label class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 cursor-pointer ${col.disabled ? 'opacity-50 cursor-not-allowed' : ''}" style="background: var(--bg-tertiary);">
          <input 
            type="checkbox" 
            class="column-checkbox w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" 
            data-column="${col.id}"
            ${tableSettings.visibleColumns[col.id] ? 'checked' : ''}
            ${col.disabled ? 'disabled' : ''}
          >
          <span class="text-sm font-medium" style="color: var(--text-primary);">${col.label}</span>
        </label>
      `).join('');

      // Add event listeners to checkboxes
      container.querySelectorAll('.column-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const column = e.target.getAttribute('data-column');
          tableSettings.visibleColumns[column] = e.target.checked;
          renderDataTable();
          updateColumnCountBadge();
        });
      });

      updateColumnCountBadge();
    }

    function updateColumnCheckboxes() {
      document.querySelectorAll('.column-checkbox').forEach(checkbox => {
        const column = checkbox.getAttribute('data-column');
        checkbox.checked = tableSettings.visibleColumns[column];
      });
      updateColumnCountBadge();
    }

    function updateColumnCountBadge() {
      const count = Object.values(tableSettings.visibleColumns).filter(v => v).length;
      document.getElementById('column-count-badge').textContent = count;
    }

    function renderMortalityCharts(data = null) {
      const filtered = data || rawData.filter(d => !d.isYearlyAggregate);
      const labels = filtered.map(d => d.periode);

      // Mortality Trend Chart
      if (charts.mortality) charts.mortality.destroy();
      const ctxMortality = document.getElementById('chart-mortality').getContext('2d');
      charts.mortality = new Chart(ctxMortality, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'NDR (â€°)',
            data: filtered.map(d => d.ndr),
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4
          }, {
            label: 'GDR (â€°)',
            data: filtered.map(d => d.gdr),
            borderColor: '#ec4899',
            backgroundColor: 'rgba(236, 72, 153, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { 
            legend: { position: 'top' },
            datalabels: { display: false }
          },
          scales: {
            x: { 
              grid: { display: false }
            },
            y: { 
              grid: { color: 'rgba(0, 0, 0, 0.05)', drawTicks: false }
            }
          }
        }
      });

      // Mortality Breakdown Chart
      if (charts.mortalityBreakdown) charts.mortalityBreakdown.destroy();
      const ctxBreakdown = document.getElementById('chart-mortality-breakdown').getContext('2d');
      charts.mortalityBreakdown = new Chart(ctxBreakdown, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Meninggal â‰¥ 48 Jam',
            data: filtered.map(d => d.meninggal48),
            backgroundColor: 'rgba(239, 68, 68, 0.7)',
            borderColor: '#ef4444',
            borderWidth: 1
          }, {
            label: 'Meninggal < 48 Jam',
            data: filtered.map(d => d.meninggalKurang48),
            backgroundColor: 'rgba(251, 146, 60, 0.7)',
            borderColor: '#fb923c',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { 
            legend: { position: 'top' },
            datalabels: { display: false }
          },
          scales: { 
            x: { 
              stacked: true,
              grid: { display: false }
            }, 
            y: { 
              stacked: true,
              grid: { color: 'rgba(0, 0, 0, 0.05)', drawTicks: false }
            } 
          }
        }
      });

      // Generate Mortality Insights
      const avgNdr = filtered.reduce((sum, d) => sum + d.ndr, 0) / filtered.length;
      const avgGdr = filtered.reduce((sum, d) => sum + d.gdr, 0) / filtered.length;
      const total48 = filtered.reduce((sum, d) => sum + d.meninggal48, 0);
      const totalLess48 = filtered.reduce((sum, d) => sum + d.meninggalKurang48, 0);

      let mortalityInsights = [];

      if (avgNdr <= 25) {
        mortalityInsights.push(`âœ… <strong>NDR Baik:</strong> Rata-rata NDR ${avgNdr.toFixed(2)}â€° berada di bawah batas maksimal (â‰¤25â€°). Kualitas perawatan sudah baik.`);
      } else {
        mortalityInsights.push(`âš ï¸ <strong>NDR Perlu Perhatian:</strong> Rata-rata NDR ${avgNdr.toFixed(2)}â€° melebihi target (â‰¤25â€°). Evaluasi protokol perawatan dan patient safety diperlukan.`);
      }

      if (avgGdr < 45) {
        mortalityInsights.push(`âœ… <strong>GDR Baik:</strong> Rata-rata GDR ${avgGdr.toFixed(2)}â€° berada di bawah batas maksimal (<45â€°).`);
      } else {
        mortalityInsights.push(`âš ï¸ <strong>GDR Tinggi:</strong> Rata-rata GDR ${avgGdr.toFixed(2)}â€° melebihi target (<45â€°). Perlu perhatian khusus pada manajemen kematian pasien.`);
      }

      mortalityInsights.push(`ğŸ“Š <strong>Distribusi Kematian:</strong> ${total48} kasus meninggal â‰¥48 jam, ${totalLess48} kasus <48 jam. Ratio ${total48 > 0 ? (total48 / (total48 + totalLess48) * 100).toFixed(1) : 0}% : ${totalLess48 > 0 ? (totalLess48 / (total48 + totalLess48) * 100).toFixed(1) : 0}%.`);

      const insightsHtml = mortalityInsights.map(i => `<div class="insight-box p-4 rounded-lg"><p class="text-sm" style="color: var(--text-primary);">${i}</p></div>`).join('');
      document.getElementById('mortality-insights').innerHTML = insightsHtml;
    }

    function exportCharts(format) {
      const chartIds = ['chart-bor-avlos', 'chart-toi-bto', 'chart-ndr-gdr', 'chart-pasien'];
      const chartNames = ['BOR_AVLOS', 'TOI_BTO', 'NDR_GDR', 'Pasien'];

      chartIds.forEach((id, index) => {
        const canvas = document.getElementById(id);
        if (!canvas) return;

        if (format === 'png') {
          const link = document.createElement('a');
          link.download = `${chartNames[index]}_Chart.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
        } else if (format === 'svg') {
          const imgData = canvas.toDataURL('image/png');
          const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}">
            <image href="${imgData}" width="${canvas.width}" height="${canvas.height}"/>
          </svg>`;
          const blob = new Blob([svg], { type: 'image/svg+xml' });
          const link = document.createElement('a');
          link.download = `${chartNames[index]}_Chart.svg`;
          link.href = URL.createObjectURL(blob);
          link.click();
          URL.revokeObjectURL(link.href);
        }
      });

      showMessage(`âœ… Grafik berhasil diexport ke ${format.toUpperCase()}`, 'success');
    }

    function exportPelayananCharts(format) {
      const chartIds = ['chart-pelayanan-pasien', 'chart-pelayanan-bor-kapasitas', 'chart-pelayanan-rawatan'];
      const chartNames = ['Tren_Pasien', 'BOR_Kapasitas', 'Hari_Rawatan'];

      chartIds.forEach((id, index) => {
        const canvas = document.getElementById(id);
        if (!canvas) return;

        if (format === 'png') {
          const link = document.createElement('a');
          link.download = `${chartNames[index]}_Chart.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
        } else if (format === 'svg') {
          const imgData = canvas.toDataURL('image/png');
          const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}">
            <image href="${imgData}" width="${canvas.width}" height="${canvas.height}"/>
          </svg>`;
          const blob = new Blob([svg], { type: 'image/svg+xml' });
          const link = document.createElement('a');
          link.download = `${chartNames[index]}_Chart.svg`;
          link.href = URL.createObjectURL(blob);
          link.click();
          URL.revokeObjectURL(link.href);
        }
      });

      showMessage(`âœ… Grafik berhasil diexport ke ${format.toUpperCase()}`, 'success');
    }

    function exportMortalityCharts(format) {
      const chartIds = ['chart-mortality', 'chart-mortality-breakdown'];
      const chartNames = ['Mortality_Trend', 'Mortality_Breakdown'];

      chartIds.forEach((id, index) => {
        const canvas = document.getElementById(id);
        if (!canvas) return;

        if (format === 'png') {
          const link = document.createElement('a');
          link.download = `${chartNames[index]}_Chart.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
        } else if (format === 'svg') {
          const imgData = canvas.toDataURL('image/png');
          const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}">
            <image href="${imgData}" width="${canvas.width}" height="${canvas.height}"/>
          </svg>`;
          const blob = new Blob([svg], { type: 'image/svg+xml' });
          const link = document.createElement('a');
          link.download = `${chartNames[index]}_Chart.svg`;
          link.href = URL.createObjectURL(blob);
          link.click();
          URL.revokeObjectURL(link.href);
        }
      });

      showMessage(`âœ… Grafik berhasil diexport ke ${format.toUpperCase()}`, 'success');
    }

    function exportTable(format) {
      const year = document.getElementById('year-filter').value;
      const month = document.getElementById('month-filter').value;

      let filtered = rawData.filter(d => !d.isYearlyAggregate);

      if (year !== 'all') {
        filtered = filtered.filter(d => {
          const parts = d.periode.split(' ');
          return parts.length === 2 && parts[1] === year;
        });
      }

      if (month !== 'all') {
        filtered = filtered.filter(d => {
          const parts = d.periode.split(' ');
          return parts.length === 2 && parts[0] === month;
        });
      }

      if (format === 'csv') {
        const headers = ['Periode', 'BOR (%)', 'AVLOS', 'TOI', 'BTO', 'NDR (â€°)', 'GDR (â€°)', 'Pasien Masuk', 'Pasien Keluar'];
        const rows = filtered.map(d => [
          d.periode,
          d.bor.toFixed(2),
          d.avlos.toFixed(2),
          d.toi.toFixed(2),
          d.bto.toFixed(2),
          d.ndr.toFixed(2),
          d.gdr.toFixed(2),
          d.jlhPasienMasuk,
          d.jlhPasienKeluar
        ]);

        const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.download = 'Data_Indikator_Rawat_Inap.csv';
        link.href = URL.createObjectURL(blob);
        link.click();
        URL.revokeObjectURL(link.href);

        showMessage('âœ… Tabel berhasil diexport ke CSV', 'success');
      } else if (format === 'excel') {
        const worksheet_data = [
          ['Periode', 'BOR (%)', 'AVLOS', 'TOI', 'BTO', 'NDR (â€°)', 'GDR (â€°)', 'Pasien Masuk', 'Pasien Keluar'],
          ...filtered.map(d => [
            d.periode,
            parseFloat(d.bor.toFixed(2)),
            parseFloat(d.avlos.toFixed(2)),
            parseFloat(d.toi.toFixed(2)),
            parseFloat(d.bto.toFixed(2)),
            parseFloat(d.ndr.toFixed(2)),
            parseFloat(d.gdr.toFixed(2)),
            d.jlhPasienMasuk,
            d.jlhPasienKeluar
          ])
        ];

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(worksheet_data);
        XLSX.utils.book_append_sheet(wb, ws, 'Data Rawat Inap');
        XLSX.writeFile(wb, 'Data_Indikator_Rawat_Inap.xlsx');

        showMessage('âœ… Tabel berhasil diexport ke Excel', 'success');
      }
    }

    loadDataFromGoogleSheets();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ba12c8fa27f83e8',t:'MTc2Nzc2NDk4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
